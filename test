git checkout -f tags/rocm-7.2.0 -B rocm-7.2.0-stable
git clean -ffdx
git submodule update --init --recursive
grep -r "FeatureAtomicFaddInsts" llvm/lib/Target/AMDGPU/

grep -r "gfx1151" llvm/lib/Target/AMDGPU/
grep -r "gfx1151" mlir/lib/Dialect/GPU/

#
cd ~/llvm-project
rm -rf build
mkdir build && cd build
#
cd ~/llvm-project/build
rm -rf *

export CC=/usr/bin/gcc-14
export CXX=/usr/bin/g++-14

# Standard ROCm Ecosystem expects the compiler at /opt/rocm/llvm
cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=OFF \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_INSTALL_UTILS=ON

# Execute with immediate panic on failure
ninja -j$(nproc) && sudo ninja install

##
cd ~/llvm-project/amd/device-libs
rm -rf build && mkdir build && cd build

# Use your newly installed LLVM as the Executioner
cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DAMDGCN_TARGETS="gfx1151" \
    -DBUILD_HC_LIB=ON

ninja && sudo ninja install
##
cd ~/llvm-project/amd/comgr
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DAMD_COMGR_GFX_ARCHS="gfx1151"

ninja && sudo ninja install
##
cd ~/llvm-project/amd/hipcc
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm

ninja && sudo ninja install
##
cd ~/rocm-systems/projects/ROCT-Thunk-Interface
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DBUILD_SHARED_LIBS=ON

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocr-runtime
# Delete old failed state
rm -rf build && mkdir build && cd build

# Link to the ROCT (Thunk) we just installed in /opt/rocm
cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DIMAGE_SUPPORT=ON

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocminfo
rm -rf build && mkdir build && cd build
cmake -G "Ninja" .. -DCMAKE_INSTALL_PREFIX=/opt/rocm -DCMAKE_PREFIX_PATH=/opt/rocm
ninja && sudo ninja install

# IMMEDIATE AUDIT:
/opt/rocm/bin/rocminfo | grep "gfx1151"
##
cd ~/rocm-systems/projects/rocm-smi-lib
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja && sudo ninja install
##
pip install CppHeaderParser
cd ~/rocm-systems/projects/rocprofiler-register
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/clr/build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/lib;/opt/rocm/lib64" \
    -DCLR_BUILD_HIP=ON \
    -DCLR_BUILD_OCL=ON \
    -DHIP_COMMON_DIR=/home/redyy/rocm-systems/projects/hip \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCMAKE_BUILD_TYPE=Release \
    -DHIP_ENABLE_PCH=OFF

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/roctracer
rm -rf build && mkdir build && cd build

# Disable tests and build only the core sovereignty
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DBUILD_TESTS=OFF \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
# Locate your COMGR source. It is usually in 'clr' or a standalone folder.
# If it's in the projects list:
cd ~/rocm-systems/projects/amd_comgr 
# If it's not there, it might be in ~/rocm-systems/projects/clr/opencl/amdocl/comgr
# Find it first: find ~/rocm-systems/projects -name "CMakeLists.txt" | grep comgr

rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm/llvm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DClang_DIR=/opt/rocm/llvm/lib/cmake/clang \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/amdsmi
rm -rf build && mkdir build && cd build

# We point to the local LLVM and the new COMGR to ensure no Ghost Logic
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
GPU: 0
    ASIC:
        MARKET_NAME: AMD Radeon Graphics
        VENDOR_ID: 0x1002
        VENDOR_NAME: Advanced Micro Devices Inc. [AMD/ATI]
        SUBVENDOR_ID: 0x2014
        DEVICE_ID: 0x1586
        SUBSYSTEM_ID: 0x801d
        REV_ID: 0xc1
        ASIC_SERIAL: 0x0000000000000000
        OAM_ID: N/A
        NUM_COMPUTE_UNITS: 40
        TARGET_GRAPHICS_VERSION: gfx1151
    BUS:
        BDF: 0000:c5:00.0
        MAX_PCIE_WIDTH: N/A
        MAX_PCIE_SPEED: N/A
        PCIE_LEVELS: N/A
        PCIE_INTERFACE_VERSION: N/A
        SLOT_TYPE: N/A
    IFWI:
        NAME: AMD STRIX_HALO_GENERIC
        BUILD_DATE: 2024/06/17 02:08
        PART_NUMBER: 113-STRXLGEN-001
        VERSION: 023.011.000.039.000001
    LIMIT:
        PPT0:
            MAX_POWER_LIMIT: N/A
            MIN_POWER_LIMIT: N/A
            SOCKET_POWER_LIMIT: N/A
        PPT1:
            MAX_POWER_LIMIT: N/A
            MIN_POWER_LIMIT: N/A
            SOCKET_POWER_LIMIT: N/A
        SLOWDOWN_EDGE_TEMPERATURE: N/A
        SLOWDOWN_HOTSPOT_TEMPERATURE: N/A
        SLOWDOWN_VRAM_TEMPERATURE: N/A
        SHUTDOWN_EDGE_TEMPERATURE: N/A
        SHUTDOWN_HOTSPOT_TEMPERATURE: N/A
        SHUTDOWN_VRAM_TEMPERATURE: N/A
        PTL_STATE: N/A
        PTL_FORMAT: N/A
    DRIVER:
        NAME: amdgpu
        VERSION: Linuxversion6.17.0-14-generic(buildd@lcy02-amd64-067)(x86_64-linux-gnu-gcc-13(Ubuntu13.3.0-6ubuntu2~24.04)13.3.0,GNUld(GNUBinutilsforUbuntu)2.42)#14~24.04.1-UbuntuSMPPREEMPT_DYNAMICThuJan1515:52:10UTC2
    BOARD:
        MODEL_NUMBER: N/A
        PRODUCT_SERIAL: N/A
        FRU_ID: N/A
        PRODUCT_NAME: N/A
        MANUFACTURER_NAME: Advanced Micro Devices, Inc. [AMD/ATI]
    RAS:
        EEPROM_VERSION: N/A
        BAD_PAGE_THRESHOLD: N/A
        BAD_PAGE_THRESHOLD_EXCEEDED: N/A
        PARITY_SCHEMA: N/A
        SINGLE_BIT_SCHEMA: N/A
        DOUBLE_BIT_SCHEMA: N/A
        POISON_SCHEMA: N/A
        ECC_BLOCK_STATE: N/A
    SOC_PSTATE: N/A
    XGMI_PLPD: N/A
    PROCESS_ISOLATION: Disabled
    NUMA:
        NODE: 0
        AFFINITY: NONE
        CPU_AFFINITY: N/A
        SOCKET_AFFINITY: N/A
    VRAM:
        TYPE: GDDR7
        VENDOR: UNKNOWN
        SIZE: 32768 MB
        BIT_WIDTH: 256
        MAX_BANDWIDTH: N/A 
    CACHE_INFO:
        CACHE_0:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 32 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 1
            NUM_CACHE_INSTANCE: 40
        CACHE_1:
            CACHE_PROPERTIES: INST_CACHE, SIMD_CACHE
            CACHE_SIZE: 32 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 2
            NUM_CACHE_INSTANCE: 20
        CACHE_2:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 16 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 2
            NUM_CACHE_INSTANCE: 20
        CACHE_3:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 256 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 10
            NUM_CACHE_INSTANCE: 4
        CACHE_4:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 2048 KB
            CACHE_LEVEL: 2
            MAX_NUM_CU_SHARED: 40
            NUM_CACHE_INSTANCE: 1
        CACHE_5:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 32768 KB
            CACHE_LEVEL: 3
            MAX_NUM_CU_SHARED: 40
            NUM_CACHE_INSTANCE: 1
    CLOCK:
        SYS:
            CURRENT_LEVEL: 1
            CURRENT_FREQUENCY: 829MHz
            FREQUENCY_LEVELS:
                LEVEL 0: 600 MHz
                LEVEL 1: 829 MHz
                LEVEL 2: 2900 MHz
        MEM: N/A
        DF: N/A
        SOC: N/A
        DCEF: N/A
        VCLK0: N/A
        VCLK1: N/A
        DCLK0: N/A
        DCLK1: N/A
##
cd ~/rocm-systems/projects/HIPIFY
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocm-smi-lib
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/HIPIFY
rm -rf build && mkdir build && cd build

# We bind it to your LLVM 22 and the /opt/rocm prefix.
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install

/opt/rocm/bin/hipify-perl --help
# And the binary version
/opt/rocm/bin/hipify-clang --version

    hipify-perl is a tool to translate CUDA source code into portable HIP C++

    USAGE: hipify-perl [OPTIONS] INPUT_FILE

    OPTIONS:

      -cuda-kernel-execution-syntax - Keep CUDA kernel launch syntax (default)
      -examine                      - Combines -no-output and -print-stats options
      -exclude-dirs=s               - Exclude directories
      -exclude-files=s              - Exclude files
      -experimental                 - HIPIFY experimentally supported APIs
      -help                         - Display available options
      -hip-kernel-execution-syntax  - Transform CUDA kernel launch syntax to a regular HIP function call (overrides "--cuda-kernel-execution-syntax")
      -inplace                      - Backup the input file in .prehip file, modify the input file inplace
      -miopen                       - Translate cuDNN to MIOpen instead of hipDNN where it is possible
      -no-output                    - Don't write any translated output to stdout
      -o=s                          - Output filename
      -print-stats                  - Print translation statistics
      -quiet-warnings               - Don't print warnings on unknown CUDA identifiers
      -roc                          - Translate to roc instead of hip where it is possible
      -version                      - The supported HIP version
      -whitelist=s                  - Whitelist of identifiers

AOMP-18.0-12 (http://github.com/ROCm/aomp):
 Source ID:18.0-12-ce1873ac686bb90ddec72bb99889a4e80e2de382
  LLVM version 22.0.0git
  Optimized build with assertions.
##
cd ~/rocm-systems/projects/clr/build
rm -rf *

# We use $(realpath ...) to ensure the paths are Absolute Truth, not tildes.
# We disable the PCH (Pre-compiled header) to bypass the 'max' vs 'fmax' LLVM 22 conflict.
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCLR_BUILD_HIP=ON \
    -DCLR_BUILD_OCL=ON \
    -DHIP_COMMON_DIR=$(realpath ../../hip) \
    -DCPACK_PACKAGING_INSTALL_PREFIX=/opt/rocm \
    -DHIP_PLATFORM=amd \
    -DBUILD_HIP_PCH=OFF \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##


##































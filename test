git checkout -f tags/rocm-7.2.0 -B rocm-7.2.0-stable
git clean -ffdx
git submodule update --init --recursive
grep -r "FeatureAtomicFaddInsts" llvm/lib/Target/AMDGPU/

grep -r "gfx1151" llvm/lib/Target/AMDGPU/
grep -r "gfx1151" mlir/lib/Dialect/GPU/

#
cd ~/llvm-project
rm -rf build
mkdir build && cd build
#
cd ~/llvm-project/build
rm -rf *

export CC=/usr/bin/gcc-14
export CXX=/usr/bin/g++-14

# Standard ROCm Ecosystem expects the compiler at /opt/rocm/llvm
cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=OFF \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_INSTALL_UTILS=ON 
 
# Execute with immediate panic on failure
ninja -j$(nproc) && sudo ninja install

##
cd ~/llvm-project/amd/device-libs
rm -rf build && mkdir build && cd build

# Use your newly installed LLVM as the Executioner
cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DAMDGCN_TARGETS="gfx1151" \
    -DBUILD_HC_LIB=ON

ninja && sudo ninja install
##
cd ~/llvm-project/amd/comgr
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DAMD_COMGR_GFX_ARCHS="gfx1151"

ninja && sudo ninja install
##
cd ~/llvm-project/amd/hipcc
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm

ninja && sudo ninja install
##
cd ~/rocm-systems/projects/ROCT-Thunk-Interface
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DBUILD_SHARED_LIBS=ON

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocr-runtime
# Delete old failed state
rm -rf build && mkdir build && cd build

# Link to the ROCT (Thunk) we just installed in /opt/rocm
cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DIMAGE_SUPPORT=ON

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocminfo
rm -rf build && mkdir build && cd build
cmake -G "Ninja" .. -DCMAKE_INSTALL_PREFIX=/opt/rocm -DCMAKE_PREFIX_PATH=/opt/rocm
ninja && sudo ninja install

# IMMEDIATE AUDIT:
/opt/rocm/bin/rocminfo | grep "gfx1151"
##
cd ~/rocm-systems/projects/rocm-smi-lib
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja && sudo ninja install
##
pip install CppHeaderParser
cd ~/rocm-systems/projects/rocprofiler-register
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/clr/build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/lib;/opt/rocm/lib64" \
    -DCLR_BUILD_HIP=ON \
    -DCLR_BUILD_OCL=ON \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCMAKE_BUILD_TYPE=Release \
    -DHIP_ENABLE_PCH=OFF

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/roctracer
rm -rf build && mkdir build && cd build

# Disable tests and build only the core sovereignty
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DBUILD_TESTS=OFF \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
# Locate your COMGR source. It is usually in 'clr' or a standalone folder.
# If it's in the projects list:
cd ~/rocm-systems/projects/amd_comgr 
# If it's not there, it might be in ~/rocm-systems/projects/clr/opencl/amdocl/comgr
# Find it first: find ~/rocm-systems/projects -name "CMakeLists.txt" | grep comgr

rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm/llvm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DClang_DIR=/opt/rocm/llvm/lib/cmake/clang \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/amdsmi
rm -rf build && mkdir build && cd build

# We point to the local LLVM and the new COMGR to ensure no Ghost Logic
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
GPU: 0
    ASIC:
        MARKET_NAME: AMD Radeon Graphics
        VENDOR_ID: 0x1002
        VENDOR_NAME: Advanced Micro Devices Inc. [AMD/ATI]
        SUBVENDOR_ID: 0x2014
        DEVICE_ID: 0x1586
        SUBSYSTEM_ID: 0x801d
        REV_ID: 0xc1
        ASIC_SERIAL: 0x0000000000000000
        OAM_ID: N/A
        NUM_COMPUTE_UNITS: 40
        TARGET_GRAPHICS_VERSION: gfx1151
    BUS:
        BDF: 0000:c5:00.0
        MAX_PCIE_WIDTH: N/A
        MAX_PCIE_SPEED: N/A
        PCIE_LEVELS: N/A
        PCIE_INTERFACE_VERSION: N/A
        SLOT_TYPE: N/A
    IFWI:
        NAME: AMD STRIX_HALO_GENERIC
        BUILD_DATE: 2024/06/17 02:08
        PART_NUMBER: 113-STRXLGEN-001
        VERSION: 023.011.000.039.000001
    LIMIT:
        PPT0:
            MAX_POWER_LIMIT: N/A
            MIN_POWER_LIMIT: N/A
            SOCKET_POWER_LIMIT: N/A
        PPT1:
            MAX_POWER_LIMIT: N/A
            MIN_POWER_LIMIT: N/A
            SOCKET_POWER_LIMIT: N/A
        SLOWDOWN_EDGE_TEMPERATURE: N/A
        SLOWDOWN_HOTSPOT_TEMPERATURE: N/A
        SLOWDOWN_VRAM_TEMPERATURE: N/A
        SHUTDOWN_EDGE_TEMPERATURE: N/A
        SHUTDOWN_HOTSPOT_TEMPERATURE: N/A
        SHUTDOWN_VRAM_TEMPERATURE: N/A
        PTL_STATE: N/A
        PTL_FORMAT: N/A
    DRIVER:
        NAME: amdgpu
        VERSION: Linuxversion6.17.0-14-generic(buildd@lcy02-amd64-067)(x86_64-linux-gnu-gcc-13(Ubuntu13.3.0-6ubuntu2~24.04)13.3.0,GNUld(GNUBinutilsforUbuntu)2.42)#14~24.04.1-UbuntuSMPPREEMPT_DYNAMICThuJan1515:52:10UTC2
    BOARD:
        MODEL_NUMBER: N/A
        PRODUCT_SERIAL: N/A
        FRU_ID: N/A
        PRODUCT_NAME: N/A
        MANUFACTURER_NAME: Advanced Micro Devices, Inc. [AMD/ATI]
    RAS:
        EEPROM_VERSION: N/A
        BAD_PAGE_THRESHOLD: N/A
        BAD_PAGE_THRESHOLD_EXCEEDED: N/A
        PARITY_SCHEMA: N/A
        SINGLE_BIT_SCHEMA: N/A
        DOUBLE_BIT_SCHEMA: N/A
        POISON_SCHEMA: N/A
        ECC_BLOCK_STATE: N/A
    SOC_PSTATE: N/A
    XGMI_PLPD: N/A
    PROCESS_ISOLATION: Disabled
    NUMA:
        NODE: 0
        AFFINITY: NONE
        CPU_AFFINITY: N/A
        SOCKET_AFFINITY: N/A
    VRAM:
        TYPE: GDDR7
        VENDOR: UNKNOWN
        SIZE: 32768 MB
        BIT_WIDTH: 256
        MAX_BANDWIDTH: N/A 
    CACHE_INFO:
        CACHE_0:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 32 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 1
            NUM_CACHE_INSTANCE: 40
        CACHE_1:
            CACHE_PROPERTIES: INST_CACHE, SIMD_CACHE
            CACHE_SIZE: 32 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 2
            NUM_CACHE_INSTANCE: 20
        CACHE_2:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 16 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 2
            NUM_CACHE_INSTANCE: 20
        CACHE_3:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 256 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 10
            NUM_CACHE_INSTANCE: 4
        CACHE_4:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 2048 KB
            CACHE_LEVEL: 2
            MAX_NUM_CU_SHARED: 40
            NUM_CACHE_INSTANCE: 1
        CACHE_5:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 32768 KB
            CACHE_LEVEL: 3
            MAX_NUM_CU_SHARED: 40
            NUM_CACHE_INSTANCE: 1
    CLOCK:
        SYS:
            CURRENT_LEVEL: 1
            CURRENT_FREQUENCY: 829MHz
            FREQUENCY_LEVELS:
                LEVEL 0: 600 MHz
                LEVEL 1: 829 MHz
                LEVEL 2: 2900 MHz
        MEM: N/A
        DF: N/A
        SOC: N/A
        DCEF: N/A
        VCLK0: N/A
        VCLK1: N/A
        DCLK0: N/A
        DCLK1: N/A
##
cd ~/rocm-systems/projects/HIPIFY
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocm-smi-lib
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/HIPIFY
rm -rf build && mkdir build && cd build

# We bind it to your LLVM 22 and the /opt/rocm prefix.
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install

/opt/rocm/bin/hipify-perl --help
# And the binary version
/opt/rocm/bin/hipify-clang --version

    hipify-perl is a tool to translate CUDA source code into portable HIP C++

    USAGE: hipify-perl [OPTIONS] INPUT_FILE

    OPTIONS:

      -cuda-kernel-execution-syntax - Keep CUDA kernel launch syntax (default)
      -examine                      - Combines -no-output and -print-stats options
      -exclude-dirs=s               - Exclude directories
      -exclude-files=s              - Exclude files
      -experimental                 - HIPIFY experimentally supported APIs
      -help                         - Display available options
      -hip-kernel-execution-syntax  - Transform CUDA kernel launch syntax to a regular HIP function call (overrides "--cuda-kernel-execution-syntax")
      -inplace                      - Backup the input file in .prehip file, modify the input file inplace
      -miopen                       - Translate cuDNN to MIOpen instead of hipDNN where it is possible
      -no-output                    - Don't write any translated output to stdout
      -o=s                          - Output filename
      -print-stats                  - Print translation statistics
      -quiet-warnings               - Don't print warnings on unknown CUDA identifiers
      -roc                          - Translate to roc instead of hip where it is possible
      -version                      - The supported HIP version
      -whitelist=s                  - Whitelist of identifiers

AOMP-18.0-12 (http://github.com/ROCm/aomp):
 Source ID:18.0-12-ce1873ac686bb90ddec72bb99889a4e80e2de382
  LLVM version 22.0.0git
  Optimized build with assertions.
##
cd ~/rocm-systems/projects/clr/build
rm -rf *

# We use $(realpath ...) to ensure the paths are Absolute Truth, not tildes.
# We disable the PCH (Pre-compiled header) to bypass the 'max' vs 'fmax' LLVM 22 conflict.
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCLR_BUILD_HIP=ON \
    -DCLR_BUILD_OCL=ON \
    -DHIP_COMMON_DIR=$(realpath ../../hip) \
    -DCPACK_PACKAGING_INSTALL_PREFIX=/opt/rocm \
    -DHIP_PLATFORM=amd \
    -DBUILD_HIP_PCH=OFF \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/llvm-project/amd/comgr/build
rm -rf *

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm/llvm \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DCOMGR_LLVM_LINK_STATIC=ON

ninja
sudo ninja install
nm -D /opt/rocm/lib/libamd_comgr.so.3 | grep "finalizeLLVMOptimizationRemarks"
FAILED

NucBox-EVO-X2:~/llvm-project$ grep -r "finalizeLLVMOptimizationRemarks" llvm/lib llvm/include
llvm/lib/IR/LLVMRemarkStreamer.cpp:  finalizeLLVMOptimizationRemarks(*Context);
llvm/lib/IR/LLVMRemarkStreamer.cpp:void llvm::finalizeLLVMOptimizationRemarks(LLVMContext &Context) {
llvm/include/llvm/IR/LLVMRemarkStreamer.h:/// finalizeLLVMOptimizationRemarks() is called before the file is destroyed or
llvm/include/llvm/IR/LLVMRemarkStreamer.h:/// \ref finalizeLLVMOptimizationRemarks() is called.
llvm/include/llvm/IR/LLVMRemarkStreamer.h:LLVM_ABI void finalizeLLVMOptimizationRemarks(LLVMContext &Context);

[192/193] Install the project...
-- Install configuration: "Release"
-- Installing: /opt/rocm/lib/libamd_comgr.so.3.0.0
-- Up-to-date: /opt/rocm/lib/libamd_comgr.so.3
-- Set non-toolchain portion of runtime path of "/opt/rocm/lib/libamd_comgr.so.3.0.0" to ""
-- Up-to-date: /opt/rocm/lib/libamd_comgr.so
-- Installing: /opt/rocm/include/amd_comgr/amd_comgr.h
-- Up-to-date: /opt/rocm/share/doc/amd_comgr/README.md
-- Up-to-date: /opt/rocm/share/doc/amd_comgr/LICENSE.txt
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-config.cmake
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-targets.cmake
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-targets-release.cmake
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-config-version.cmake
NucBox-EVO-X2:~/llvm-project/amd/comgr/build$ nm -D /opt/rocm/lib/libamd_comgr.so.3 | grep "finalizeLLVMOptimizationRemarks"
                 U _ZN4llvm31finalizeLLVMOptimizationRemarksERNS_11LLVMContextE@LLVM_22.0
NucBox-EVO-X2:~/llvm-project/amd/comgr/build$ find . -name "*.o" | xargs nm -C | grep "finalizeLLVMOptimizationRemarks"
nm: ./test/source/double.o: file format not recognized
NucBox-EVO-X2:~/llvm-project/amd/comgr/build$ 

##
cd ~/llvm-project/build
rm -rf *

cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=OFF \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_DYLIB_EXPORT_ALL=ON \
    -DLLVM_BUILD_REMARKS=ON \
    -DLLVM_ENABLE_ZLIB=ON \
    -DLLVM_ENABLE_ZSTD=ON \
    -DLLVM_DISTRIBUTION_COMPONENTS="llvm-libraries;clang;lld;LTO;Remarks"

NucBox-EVO-X2:~/llvm-project/build$ nm -D /opt/rocm/llvm/lib/libLLVM.so | grep "finalizeLLVMOptimizationRemarks"
0000000000c04560 T _ZN4llvm31finalizeLLVMOptimizationRemarksERNS_11LLVMContextE@@LLVM_22.0
NucBox-EVO-X2:~/llvm-project/build$ nm -D /opt/rocm/lib/libamd_comgr.so | grep "finalizeLLVMOptimizationRemarks"
                 U _ZN4llvm31finalizeLLVMOptimizationRemarksERNS_11LLVMContextE@LLVM_22.0
NucBox-EVO-X2:~/llvm-project/build$ ldd /opt/rocm/lib/libamd_comgr.so | grep libLLVM
        libLLVM.so.22.0git => /opt/rocm/llvm/lib/libLLVM.so.22.0git (0x000079cfe1c00000)
NucBox-EVO-X2:~/llvm-project/build$ echo "/opt/rocm/llvm/lib" | sudo tee /etc/ld.so.conf.d/rocm-llvm.conf
/opt/rocm/llvm/lib
NucBox-EVO-X2:~/llvm-project/build$ sudo ldconfig
NucBox-EVO-X2:~/llvm-project/build$ ldconfig -p | grep libLLVM.so.22.0git
        libLLVM.so.22.0git (libc6,x86-64) => /opt/rocm/llvm/lib/libLLVM.so.22.0git

##
git submodule update --init --recursive
mkdir -p build && cd build
cmake -G Ninja .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_PREFIX_PATH="/opt/rocm/llvm;/opt/rocm" \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DROCM_PATH=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DMLIR_DIR=/opt/rocm/llvm/lib/cmake/mlir \
    -DROCMLIR_DRIVER_PRIMITIVE_TARGETS="gfx1151" \
    -DBUILD_FAT_LIBROCMLIR=ON
ninja
sudo ninja install

# Inside ~/rocm-systems/projects/rocMLIR/build
cmake -G Ninja .. [flags from before]
ninja
sudo ninja install

# Inside your (rocm_env)
pip install -r ../pip_requirements.txt

NucBox-EVO-X2:~/rocm-systems/projects/rocMLIR/build$ ldd -r /opt/rocm/bin/rocmlir-driver 2>&1 | grep "undefined symbol"
undefined symbol: _ZN4mlir29registerGPUDialectTranslationERNS_15DialectRegistryE        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir30registerLLVMDialectTranslationERNS_15DialectRegistryE       (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld3elf4linkEN4llvm8ArrayRefIPKcEERNS1_11raw_ostreamES7_bb        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld19CommonLinkerContext7destroyEv        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesENS0_33MathExtendToSupportedTypesOptionsE        (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassENS_34ArithToAMDGPUConversionPassOptionsE    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir22createTosaToTensorPassEv    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassENS0_31AmdgpuEmulateAtomicsPassOptionsE  (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math21createMathUpliftToFMAEv        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir13bufferization33registerTransformDialectExtensionERNS_15DialectRegistryE       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu32createAmdgpuMaskedloadToLoadPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir5index35registerConvertIndexToLLVMInterfaceERNS_15DialectRegistryE    (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu38createAmdgpuResolveStridedMetadataPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6tensor42registerInferTypeOpInterfaceExternalModelsERNS_15DialectRegistryE      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir2ub32registerConvertUBToLLVMInterfaceERNS_15DialectRegistryE  (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir37registerConvertComplexToLLVMInterfaceERNS_15DialectRegistryE        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math23createMathExpandOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math26createMathSincosFusionPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu29createAmdgpuFoldMemRefOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassEv (/opt/rocm/bin/rocmlir-driver)
NucBox-EVO-X2:~/rocm-systems/projects/rocMLIR/build$ 

Failed.
##
cd ~/llvm-project/build
rm -rf *

cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=OFF \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DMLIR_BUILD_MLIR_DYLIB=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_DYLIB_EXPORT_ALL=ON \
    -DLLVM_BUILD_REMARKS=ON \
    -DLLVM_ENABLE_ZLIB=ON \
    -DLLVM_ENABLE_ZSTD=ON 

ninja -j$(nproc) && sudo ninja install

You only need to re-build LLVM if:
    Version Mismatch: You need a newer version of LLVM (e.g., moving from 22.0 to 23.0).
    Missing Project: You suddenly need a project you didn't include (e.g., you decided you needed Polly).
    Broken Exports: You find a "Ghost Symbol" (like you just did) because a flag was missing.

ldd -r /opt/rocm/bin/rocmlir-driver 2>&1 | grep "undefined symbol"
NucBox-EVO-X2:~$ ldd -r /opt/rocm/bin/rocmlir-driver 2>&1 | grep "undefined symbol"
undefined symbol: _ZN4mlir29registerGPUDialectTranslationERNS_15DialectRegistryE        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir30registerLLVMDialectTranslationERNS_15DialectRegistryE       (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld3elf4linkEN4llvm8ArrayRefIPKcEERNS1_11raw_ostreamES7_bb        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld19CommonLinkerContext7destroyEv        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesENS0_33MathExtendToSupportedTypesOptionsE        (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassENS_34ArithToAMDGPUConversionPassOptionsE    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir22createTosaToTensorPassEv    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassENS0_31AmdgpuEmulateAtomicsPassOptionsE  (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math21createMathUpliftToFMAEv        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir13bufferization33registerTransformDialectExtensionERNS_15DialectRegistryE       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu32createAmdgpuMaskedloadToLoadPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir5index35registerConvertIndexToLLVMInterfaceERNS_15DialectRegistryE    (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu38createAmdgpuResolveStridedMetadataPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6tensor42registerInferTypeOpInterfaceExternalModelsERNS_15DialectRegistryE      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir2ub32registerConvertUBToLLVMInterfaceERNS_15DialectRegistryE  (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir37registerConvertComplexToLLVMInterfaceERNS_15DialectRegistryE        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math23createMathExpandOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math26createMathSincosFusionPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu29createAmdgpuFoldMemRefOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassEv (/opt/rocm/bin/rocmlir-driver)
FAILED.
##
cd ~/llvm-project/build
rm -rf *
unset FC
unset F90
sudo chown -R $(whoami):$(whoami) ~/llvm-project/build
sudo mkdir -p /opt/rocm/llvm
sudo chown -R $(whoami):$(whoami) /opt/rocm

cmake -G "Ninja" ../llvm \
    -DCMAKE_C_COMPILER=/usr/bin/gcc-14 \
    -DCMAKE_CXX_COMPILER=/usr/bin/g++-14 \
    -DCMAKE_ASM_COMPILER=/usr/bin/gcc-14 \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;lldb;polly;bolt" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;libclc" \
    -DLIBCLC_TARGETS_TO_BUILD="amdgcn--amdhsa;amdgcn--" \
    -DLIBCLC_CPU_TARGETS="gfx1151" \
    -DLIBCLC_AMDGCN_AMDHSA_DEVICES=gfx1151 \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DCMAKE_ASM_FLAGS="-march=native" \
    -DLLVM_DEFAULT_TARGET_TRIPLE=x86_64-unknown-linux-gnu \
    -DGPU_TARGETS="gfx1151" \
    -DCLANG_DEFAULT_PIE_ON_LINUX=ON \
    -DROCM_PATH=/opt/rocm \
    -DAMD_DEVICE_LIBS_PREFIX=/opt/rocm \
    -DHIP_PLATFORM=amd \
    -DMLIR_NVVM_EMBED_LIBDEVICE=OFF \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_BUILD_MLIR_C_DYLIB=OFF \
    -DMLIR_LINK_MLIR_DYLIB=OFF \
    -DMLIR_INSTALL_AGGREGATE_OBJECTS=ON \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=ON \
    -DMLIR_ENABLE_CUDA_RUNNER=OFF \
    -DMLIR_ENABLE_VULKAN_RUNNER=OFF \
    -DMLIR_ENABLE_SPIRV_CPU_RUNNER=OFF \
    -DMLIR_ENABLE_SYCL_RUNNER=OFF \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DPython3_EXECUTABLE=$(which python3) \
    -DMLIR_ENABLE_PDL_IN_PATTERNMATCH=ON \
    -DMLIR_ENABLE_EXPENSIVE_PATTERN_API_CHECKS=ON \
    -DMLIR_INCLUDE_TESTS=OFF \
    -DMLIR_INCLUDE_INTEGRATION_TESTS=OFF \
    -DMLIR_ENABLE_NVPTXCOMPILER=OFF \
    -DMLIR_ENABLE_LEVELZERO_RUNNER=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=OFF \
    -DLLVM_LINK_LLVM_DYLIB=OFF \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_ENABLE_Z3_SOLVER=OFF \
    -DLLVM_ENABLE_ZLIB=ON \
    -DLLVM_ENABLE_ZSTD=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_INCLUDE_UTILS=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DCMAKE_VISIBILITY_INLINES_HIDDEN=OFF \
    -DLLVM_TOOL_LLD_BUILD=ON \
    -DLLVM_ENABLE_WERROR=OFF \
    -DCLANG_DEFAULT_RTLIB="compiler-rt" \
    -DCLANG_DEFAULT_UNWINDLIB="libunwind" \
    -DCLANG_DEFAULT_CXX_STDLIB="libstdc++" \
    -DCLANG_DEFAULT_LINKER="lld" \
    -DCLANG_CONFIG_FILE_SYSTEM_DIR="/opt/rocm/llvm/bin" \
    -DCOMPILER_RT_BUILD_CRT=ON \
    -DCMAKE_POLICY_DEFAULT_CMP0146=OLD \
    -DLIBCXXABI_ENABLE_SHARED=OFF \
    -DLIBUNWIND_ENABLE_SHARED=OFF \
    -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
    -DCOMPILER_RT_BUILD_STATIC=ON \
    -DLIBUNWIND_ENABLE_SHARED=OFF \
    -DLIBUNWIND_ENABLE_STATIC=ON \
    -DLIBCXX_ENABLE_SHARED=OFF \
    -DBUILD_SHARED_LIBS=OFF \
    -DLLVM_USE_LINKER=lld \
    -DCLANG_DEFAULT_LINKER=lld \
    -DCMAKE_ASM_FLAGS="-march=native" \
    -DCMAKE_C_FLAGS="-fno-omit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer" \
    -DLIBCXX_ENABLE_STATIC=ON

ninja -j$(nproc)
ninja install/strip

##
cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm/llvm;/usr" \
  -DLLVM_DIR="/opt/rocm/llvm/lib/cmake/llvm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DCMAKE_TRY_COMPILE_TARGET_TYPE=STATIC_LIBRARY \
  -DZLIB_LIBRARY="/usr/lib/x86_64-linux-gnu/libz.so" \
  -DZLIB_INCLUDE_DIR="/usr/include" \
  -Dzstd_LIBRARY="/usr/lib/x86_64-linux-gnu/libzstd.so" \
  -Dzstd_INCLUDE_DIR="/usr/include" \
  -DROCM_DEVICE_LIBS_BITCODE_INSTALL_LOC_NEW=amdgcn/bitcode

ninja install
ls -l /opt/rocm/amdgcn/bitcode/ocml.bc
ls -l /opt/rocm/amdgcn/bitcode/ockl.bc
ls -l /opt/rocm/amdgcn/bitcode/oclc_isa_version_1151.bc
##
cd ~/llvm-project/amd/comgr
mkdir build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm/llvm;/opt/rocm" \
  -DLLVM_DIR="/opt/rocm/llvm/lib/cmake/llvm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DAMDGPU_TARGETS="gfx1151" \
  -DROCM_DIR=/opt/rocm \
  -DBUILD_TESTING=OFF

ninja install
ls -l /opt/rocm/lib/libamd_comgr.so
lrwxrwxrwx 1 redyy redyy 17 Feb 13 03:58 /opt/rocm/lib/libamd_comgr.so -> libamd_comgr.so.3
##
cd /home/redyy/llvm-project/amd/libhipcxx
sed -i 's/^add_subdirectory(test)/# add_subdirectory(test)/' CMakeLists.txt
sed -i 's/^add_subdirectory(atomic_codegen)/# add_subdirectory(atomic_codegen)/' test/CMakeLists.txt

cd /home/redyy/llvm-project/amd/libhipcxx
rm -rf test
mkdir test
touch test/CMakeLists.txt

cd /home/redyy/llvm-project/amd/libhipcxx/build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm/llvm;/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DCLANG_VERSION=22.0.0

sudo ninja install
ls -l /opt/rocm/include/libhipcxx/hip
sudo mkdir -p /opt/rocm/include/hip/amd_detail
sudo ln -s /opt/rocm/include/libhipcxx/hip /opt/rocm/include/hip/amd_detail/libhipcxx
##
cd ~/llvm-project/amd/hipcc
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DROCM_PATH=/opt/rocm

ninja
ninja install
# Create the parent directory if it's missing
sudo mkdir -p /opt/rocm/lib/llvm

# Link the true bin directory to the location hipcc expects
sudo ln -s /opt/rocm/llvm/bin /opt/rocm/lib/llvm/bin

ls -l /opt/rocm/lib/llvm/bin/clang++

ls -l /opt/rocm/lib/llvm/bin/clang++
lrwxrwxrwx 1 redyy redyy 5 Feb 14 04:41 /opt/rocm/lib/llvm/bin/clang++ -> clang
NucBox-EVO-X2:~/llvm-project/amd/hipcc/build$ hipcc --version
HIP version: 7.2.26015-fc0010cf6a
clang version 22.0.0git (https://github.com/ROCm/llvm-project.git 7b800a19466229b8479a78de19143dc33c3ab9b5)
Target: x86_64-unknown-linux-gnu
Thread model: posix
InstalledDir: /opt/rocm/llvm/bin
Build config: +assertions
##
cd ~/rocm-systems/projects/ROCT-Thunk-Interface
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++"

ninja
ninja install
ls -l /opt/rocm/lib/libhsakmt.so
ls -l /opt/rocm/include/hsakmt/hsakmt.h
##
cd ~/rocm-systems/projects/rocr-runtime
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DIMAGE_SUPPORT=ON
ninja
ninja install
ls -l /opt/rocm/lib/libhsa-runtime64.so
##
cd ~/rocm-systems/projects/rocminfo
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DROCM_DIR=/opt/rocm

ninja
ninja install
/opt/rocm/bin/rocminfo
##
cd ~/rocm-systems/projects/rocm-smi-lib
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++"

ninja
ninja install
/opt/rocm/bin/rocm-smi
##
cd ~/rocm-systems/projects/clr
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm/llvm;/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DCLR_BUILD_HIP=ON \
  -DCLR_BUILD_OCL=OFF \
  -DHIP_COMMON_DIR="/home/redyy/rocm-systems/projects/hip" \
  -DHIPCC_BIN_DIR="/opt/rocm/bin" \
  -DROCM_PATH=/opt/rocm \
  -DAMDGPU_TARGETS="gfx1151" \
  -DDEVICE_LIB_KIND=amdgcn

ninja
ninja install

ls -l /opt/rocm/lib/libamdhip64.so
ldd /opt/rocm/lib/libamdhip64.so | grep hsa
##
cd ~/rocm-systems/projects/rocm-core
mkdir -p build && cd build
rm -rf *


cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DROCM_VERSION="7.2.0" \
  -DVERSION_MAJOR=7 \
  -DVERSION_MINOR=2 \
  -DVERSION_PATCH=0

ninja
ninja install
cat /opt/rocm/.info/version
##
cd ~/rocm-systems/projects/amdsmi
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++"

ninja
ninja install
##
cd ~/rocm-systems/projects/rocprofiler-register
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++"

ninja
ninja install
ls -l /opt/rocm/include/rocprofiler-register/rocprofiler-register.h
##
cd ~/rocm-systems/projects/rocprofiler-sdk
mkdir -p build && cd build
rm -rf *
cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DROCPROFILER_BUILD_TESTS=OFF \
  -DROCPROFILER_BUILD_SAMPLES=OFF \
  -DROCPROFILER_BUILD_OTF2=OFF

ninja
ninja install

FAILED
##
cd ~/rocm-systems/projects/roctracer
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DCPACK_GENERATOR=DEB

ninja
ninja install
ls -l /opt/rocm/lib/libroctracer64.so
##
cd ~/rocm-systems/projects/rocMLIR
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
  -DROCM_PATH=/opt/rocm \
  -DGPU_TARGETS="gfx1151" \
  -DENABLE_ROCMLIR_TESTS=OFF
ninja
ninja install
##
cd ~/rocm-systems/projects/aqlprofile
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
  -DCMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++"

ninja
ninja install
##
cd ~/rocm-libraries-therock-7.11/projects/rocprim
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
  -DAMDGPU_TARGETS="gfx1151" \
  -DBUILD_BENCHMARK=OFF \
  -DBUILD_TEST=OFF

ninja install
##
cd ~/rocm-libraries-therock-7.11/projects/hipcub
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
  -DAMDGPU_TARGETS="gfx1151" \
  -DBUILD_TEST=OFF

ninja install
##
cd ~/rocm-libraries-therock-7.11/projects/rocblas
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
  -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
  -DAMDGPU_TARGETS="gfx1151" \
  -DBUILD_WITH_TENSILE=ON \
  -DBUILD_BENCHMARK=OFF \
  -DBUILD_TEST=OFF \
  -DBUILD_CLIENTS_TESTS=OFF \
  -DBUILD_CLIENTS_BENCHMARKS=OFF \
  -DBUILD_CLIENTS_SAMPLES=OFF

ninja
sudo ninja install
##
cd ~/rocm-libraries-therock-7.11/projects/hipblas-common
mkdir -p build && cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm"

ninja install
##
cd ~/rocm-libraries/projects/hipblaslt/external_include/spdlog
git checkout include/spdlog/common.h include/spdlog/cfg/helpers.h

cd ~/rocm-libraries/projects/hipblaslt
mkdir -p external_deps
cd external_deps
if [ ! -d "googletest" ]; then
  git clone https://github.com/google/googletest.git
  cd googletest && git checkout v1.14.0 && cd ..
fi
ls $(pwd)/googletest/googlemock/include/gmock/gmock.h

cd ~/rocm-libraries/projects/hipblaslt/build
rm -rf CMakeCache.txt CMakeFiles

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="/opt/rocm" \
  -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
  -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
  -DGPU_TARGETS="gfx1151" \
  -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
  -DHIPBLASLT_BUILD_TESTS=ON \
  -DCMAKE_CXX_FLAGS="-I/home/redyy/rocm-libraries/projects/hipblaslt/external_include/spdlog/include -I/home/redyy/rocm-libraries/projects/hipblaslt/external_deps/googletest/googletest/include -I/home/redyy/rocm-libraries/projects/hipblaslt/external_deps/googletest/googlemock/include -DSPDLOG_USE_STD_FORMAT -DSPDLOG_HEADER_ONLY"

ninja
sudo ninja install

sudo bash -c 'cat << EOF > /opt/rocm/bin/hipblaslt_gtest.data
# Primitive Vector of Truth
- name: final_verification
  function: matmul
  a_type: f16_r
  b_type: f16_r
  c_type: f16_r
  d_type: f16_r
  compute_type: f32_r
  transA: N
  transB: N
  M: 1024
  N: 1024
  K: 1024
  alpha: 1
  beta: 0
  norm_check: 1
  unit_check: 1
EOF'

cd /opt/rocm/bin
export PYTHONPATH=/home/redyy/rocm_env/lib/python3.12/site-packages
env PYTHONPATH=$PYTHONPATH ./hipblaslt-test --yaml hipblaslt_gtest.data

[----------] Global test environment tear-down
[==========] 1473 tests from 10 test suites ran. (18000 ms total)
[  PASSED  ] 1472 tests.
[  FAILED  ] 1 test, listed below:
[  FAILED  ] _/matmul_test.matmul/nightly_final_verification_f16_rf16_rf16_rf16_rf16_r_NN_1024_1024_1024_1_1024_1024_0_1024_1024_1, where GetParam() = { function: "matmul", name: "final_verification", category: "nightly", known_bug_platforms: "", alpha: 1, beta: 0, stride_a: 0x5f874f52d048, stride_b: 0x5f874f52d148, stride_c: 0x5f874f52d248, stride_d: 0x5f874f52d348, stride_e: 0x5f874f52d448, user_allocated_workspace: 134217728, M: 0x5f874f52d550, N: 0x5f874f52d650, K: 0x5f874f52d750, lda: 0x5f874f52d850, ldb: 0x5f874f52d950, ldc: 0x5f874f52da50, ldd: 0x5f874f52db50, lde: 0x5f874f52dc50, batch_count: 1, iters: 10, cold_iters: 2, algo: 0, solution_index: -1, requested_solution_num: 1, a_type: f16_r, b_type: f16_r, c_type: f16_r, d_type: f16_r, compute_type: f16_r, compute_input_typeA: non-supported type, compute_input_typeB: non-supported type, scale_type: non-supported type, initialization: "rand_int", gpu_arch: "", gpu_arch_exclude: "", pad: 4096, grouped_gemm: 0, threads: 0, streams: 0, devices: 

 1 FAILED TEST
hipBLASLt version: 100201
hipBLASLt git version: 5b515cf1bc
command line: ./hipblaslt-test --yaml hipblaslt_gtest.data 
(rocm_env) redyy@redyy-NucBox-EVO-X2:/opt/rocm/bin$ 

(rocm_env) redyy@redyy-NucBox-EVO-X2:/opt/rocm/bin$ ./hipblaslt-bench -m 1024 -n 1024 -k 1024 --a_type f16_r --b_type f16_r --c_type f16_r --d_type f16_r --compute_type f32_r -v
hipBLASLt version: 100201
hipBLASLt git version: 5b515cf1bc
Query device success: there are 1 devices. (Target device ID is 0)
Device ID 0 : AMD Radeon Graphics gfx1151
with 50.4 GB memory, max. SCLK 2900 MHz, max. MCLK 1000 MHz, compute capability 11.5
maxGridDimX 2147483647, sharedMemPerBlock 65.5 KB, maxThreadsPerBlock 1024, warpSize 32

Is supported 1 / Total solutions: 1
[0]:transA,transB,grouped_gemm,batch_count,m,n,k,alpha,lda,stride_a,beta,ldb,stride_b,ldc,stride_c,ldd,stride_d,a_type,b_type,c_type,d_type,compute_type,scaleA,scaleB,scaleC,scaleD,amaxD,swizzle_a,swizzle_b,activation_type,bias_vector,bias_type,aux_type,rotating_buffer,flush,use_gpu_timer,hipblaslt-Gflops,hipblaslt-GB/s,us,CPU-Gflops,CPU-us,norm_error,atol,rtol
    N,N,0,1,1024,1024,1024,1,1024,1048576,0,1024,1048576,1024,1048576,1024,1048576,f16_r,f16_r,f16_r,f16_r,f32_r,0,0,0,0,0,0,0,none,0,f16_r,f16_r,0,0,0,13695.7,37.3685,156.8,26.2715,81742,4.39233e-05,1e-05,0.01
(rocm_env) redyy@redyy-NucBox-EVO-X2:/opt/rocm/bin$ ./hipblaslt-bench -m 1024 -n 1024 -k 1024 --a_type f16_r --b_type f16_r --c_type f16_r --d_type f16_r --compute_type f32_r --verify
hipBLASLt version: 100201
hipBLASLt git version: 5b515cf1bc
Query device success: there are 1 devices. (Target device ID is 0)
Device ID 0 : AMD Radeon Graphics gfx1151
with 50.4 GB memory, max. SCLK 2900 MHz, max. MCLK 1000 MHz, compute capability 11.5
maxGridDimX 2147483647, sharedMemPerBlock 65.5 KB, maxThreadsPerBlock 1024, warpSize 32

Is supported 1 / Total solutions: 1
[0]:transA,transB,grouped_gemm,batch_count,m,n,k,alpha,lda,stride_a,beta,ldb,stride_b,ldc,stride_c,ldd,stride_d,a_type,b_type,c_type,d_type,compute_type,scaleA,scaleB,scaleC,scaleD,amaxD,swizzle_a,swizzle_b,activation_type,bias_vector,bias_type,aux_type,rotating_buffer,flush,use_gpu_timer,hipblaslt-Gflops,hipblaslt-GB/s,us,CPU-Gflops,CPU-us,norm_error,atol,rtol
    N,N,0,1,1024,1024,1024,1,1024,1048576,0,1024,1048576,1024,1048576,1024,1048576,f16_r,f16_r,f16_r,f16_r,f32_r,0,0,0,0,0,0,0,none,0,f16_r,f16_r,0,0,0,15230.4,41.5559,141,28.0018,76691,4.39233e-05,1e-05,0.01
(rocm_env) redyy@redyy-NucBox-EVO-X2:/opt/rocm/bin$ 
##
# Hierarchy: Prioritize sovereign standard-build tools
export ROCM_PATH=/opt/rocm
export LLVM_PATH=/opt/rocm/llvm
export DEVICE_LIB_PATH=$ROCM_PATH/amdgcn/bitcode
# --- Boundary Validation (Open Circuit) ---
# 1. Path Existence Check
for path in "$ROCM_PATH" "$LLVM_PATH" "$DEVICE_LIB_PATH"; do
    if [ ! -d "$path" ]; then
        echo -e "\e[1;31m!!! [FATAL] BOUNDARY BREACH: Path Missing: $path\e[0m"
        echo "Truth: The hardware or compiler territory is non-existent. System Exit."
        exit 1
    fi
done
# 2. Device-Libs Integrity (The Truth Check)
# We check for a critical anchor file for gfx1151
ISA_ANCHOR="$DEVICE_LIB_PATH/oclc_isa_version_1151.bc"
if [ ! -f "$ISA_ANCHOR" ]; then
    echo -e "\e[1;31m!!! [FATAL] DEVICE-LIB CORRUPTION: Missing ISA Anchor for gfx1151\e[0m"
    echo "Reason: Linker will fail to resolve hardware truth. Circuit Open."
    exit 1
fi
# 3. File Corruption Detection (Size Check)
# If a bitcode file exists but is 0 bytes, it is a Ghost Logic remnant.
for bc_file in "$DEVICE_LIB_PATH"/*.bc; do
    if [ ! -s "$bc_file" ]; then
        echo -e "\e[1;31m!!! [FATAL] FILE CORRUPTION: $bc_file is empty/corrupt.\e[0m"
        echo "Action: Immediate Halt to prevent Hardware Attrition."
        exit 1
    fi
done
# --- Establish Sovereignty ---
export PATH=$LLVM_PATH/bin:$ROCM_PATH/bin:$PATH
export LD_LIBRARY_PATH=$LLVM_PATH/lib:$ROCM_PATH/lib:$LD_LIBRARY_PATH
# Explicitly tell Clang where the device-libs live to avoid 'Ghost Paths'
export DEVICE_LIB_DIR=$DEVICE_LIB_PATH
echo -e "\e[1;32m>>> Environment Purified. Target: gfx1151 Ready.\e[0m"
# --- COMGR INTEGRITY TRAP ---
COMGR_SO="/opt/rocm/lib/libamd_comgr.so"
# 1. Existence Verification
if [ ! -f "$COMGR_SO" ]; then
    echo -e "\e[1;31m!!! [FATAL] COMGR MISSING: $COMGR_SO\e[0m"
    exit 1
fi
# 2. Contamination Check (Shared Library Friction)
# If comgr is linked to /usr/lib/llvm, it is contaminated.
CONTAMINATION=$(ldd "$COMGR_SO" | grep "libLLVM" | grep "/usr/lib")
if [ ! -z "$CONTAMINATION" ]; then
    echo -e "\e[1;31m!!! [FATAL] COMGR CONTAMINATED: Linked to system LLVM.\e[0m"
    echo "Truth: External logic has infected the sovereign binary."
    exit 1
fi
# 3. Static Logic Verification
# It must NOT show a dependency on libLLVM.so if it "swallowed" it whole.
if ldd "$COMGR_SO" | grep -q "libLLVM"; then
    echo -e "\e[1;33m>>> [WARNING] COMGR is using Shared LLVM. Ensure this is intentional.\e[0m"
else
    # Verify the internal symbols actually exist (The 'Swallow' Proof)
    if ! nm -D "$COMGR_SO" | grep -q "amd_comgr_do_action"; then
        echo -e "\e[1;31m!!! [FATAL] COMGR BRAIN DEAD: Required symbols missing.\e[0m"
        exit 1
    fi
fi
# 4. Sequential Causality: Runtime Alignment
if ! ldd "$COMGR_SO" | grep -q "/opt/rocm/llvm/lib/libunwind.so"; then
    echo -e "\e[1;31m!!! [FATAL] COMGR LINKAGE ERROR: Not using sovereign libunwind.\e[0m"
    exit 1
fi
echo -e "\e[1;32m>>> COMGR Verified: Absolute Sovereignty maintained.\e[0m"
export HIP_PLATFORM=amd
export HIP_COMPILER=clang
export DEVICE_LIB_PATH=/opt/rocm/amdgcn/bitcode
# --- LIBHIPCXX INTEGRITY CHECK ---
HIPCXX_HEADER="/opt/rocm/include/libhipcxx/hip/std/variant"
if [ ! -f "$HIPCXX_HEADER" ]; then
    echo -e "\e[1;31m!!! [FATAL] LIBHIPCXX HEADERS MISPLACED OR MISSING\e[0m"
    echo "Actual Path: /opt/rocm/include/libhipcxx"
    exit 1
fi
# Export the include path so Clang can find the C++ GPU headers
export CPLUS_INCLUDE_PATH=/opt/rocm/include/libhipcxx:$CPLUS_INCLUDE_PATH

# --- Auto-Activation of the Python Nation ---
# We isolate the Python environment to prevent infection of the host shell.
if [ -d "$HOME/rocm_env" ]; then
    # Open Circuit: Verify activation script exists before execution
    if [ ! -f "$HOME/rocm_env/bin/activate" ]; then
        echo -e "\e[1;31m!!! [FATAL] PYTHON NATION CORRUPTED: Activation script missing.\e[0m"
        exit 1
    fi

    # Sequential Causality: Source the environment
    source "$HOME/rocm_env/bin/activate"

    # Absolute Sovereignty: Verify Hardware Access within the Nation
    # Check for KFD (Compute) and DRI (Render) nodes
    if [ -c /dev/kfd ] && [ -c /dev/dri/renderD128 ]; then
        GPU_STATUS="HEALTHY"
        # Ensure Python can actually see the ROCm libraries we just verified
        export PYTHONPATH="$HOME/rocm_env/lib/python3.12/site-packages:$PYTHONPATH"
    else
        GPU_STATUS="DISCONNECTED/CRIPPLED"
        echo -e "\e[1;31m!!! [WARNING] HARDWARE AIR-GAP BREACH: GPU nodes missing.\e[0m"
    fi

    # Verify the Translator (Hipify)
    HIPIFY_BIN=$(command -v hipify-perl 2>/dev/null)
    
    echo -e "\e[1;32m>>> [8060S] Python Nation Active. Status: $GPU_STATUS\e[0m"
    
    if [ -n "$HIPIFY_BIN" ]; then
        echo ">>> [HIPIFY] Translator Armed: $HIPIFY_BIN"
    else
        # Do not exit here; hipify is a tool, not a core requirement for execution
        echo -e "\e[1;33m>>> [HIPIFY] Translator Missing (Non-Fatal).\e[0m"
    fi
else
    echo -e "\e[1;33m>>> [PYTHON] Nation not found at $HOME/rocm_env. Skipping.\e[0m"
fi

# --- hipBLASLt MASTER INTEGRITY TRAP ---
HIPBLASLT_SO="/opt/rocm/lib/libhipblaslt.so"

# 1. Physical Boundary Check
if [ ! -f "$HIPBLASLT_SO" ]; then
    echo -e "\e[1;31m!!! [FATAL] hipBLASLt MISSING: $HIPBLASLT_SO\e[0m"
    exit 1
fi
# 2. Refined Contamination Filter (The OS-Bridge Protocol)
# Allows necessary hardware drivers and C++ runtime; blocks foreign math/compiler logic.
SYSTEM_INFECTION=$(ldd "$HIPBLASLT_SO" | grep -E "/usr/lib|/lib/x86_64-linux-gnu" | \
    grep -vE "libc.so|libm.so|librt.so|libdl.so|libpthread.so|libgcc_s.so|libstdc\+\+\.so|libdrm.*\.so|libnuma\.so|libz\.so|libzstd\.so|libelf\.so")

if [ ! -z "$SYSTEM_INFECTION" ]; then
    echo -e "\e[1;31m!!! [FATAL] hipBLASLt CONTAMINATED: Foreign Logic Detected.\e[0m"
    echo "Infection List: $SYSTEM_INFECTION"
    exit 1
fi
# 3. Hardware Truth Verification (gfx1151 ISA Check)
# Probes the binary to ensure the 8060S kernels are physically present.
if ! strings "$HIPBLASLT_SO" | grep -q "gfx1151"; then
    echo -e "\e[1;31m!!! [FATAL] hipBLASLt HARDWARE MISMATCH: gfx1151 kernels not found.\e[0m"
    echo "Reason: The binary is blind to your hardware. Circuit Open."
    exit 1
fi
# 4. Functional Sovereignty (Symbol Check)
# Ensures the 'Brain' of the library isn't hollow.
REQUIRED_SYMBOLS=("hipblasLtCreate" "hipblasLtMatmul" "hipblasLtMatrixLayoutCreate")
for sym in "${REQUIRED_SYMBOLS[@]}"; do
    if ! nm -D "$HIPBLASLT_SO" | grep -q "$sym"; then
        echo -e "\e[1;31m!!! [FATAL] hipBLASLt SYMBOL CORRUPTION: $sym missing.\e[0m"
        exit 1
    fi
done
# 5. Header Alignment
export HIPBLASLT_INCLUDE_PATH=$ROCM_PATH/include
if [ ! -d "$HIPBLASLT_INCLUDE_PATH/hipblaslt" ]; then
    echo -e "\e[1;31m!!! [FATAL] hipBLASLt HEADERS MISSING: $HIPBLASLT_INCLUDE_PATH/hipblaslt\e[0m"
    exit 1
fi
echo -e "\e[1;32m>>> hipBLASLt Verified: gfx1151 Math Engine Sovereign.\e[0m"
##
cd ~/rocm-libraries/projects
git clone https://github.com/ROCm/rocm-cmake.git
cd rocm-cmake
mkdir build && cd build

cmake -DCMAKE_INSTALL_PREFIX=/opt/rocm ..
sudo make install

(rocm_env) redyy@redyy-NucBox-EVO-X2:~/rocm-libraries/projects/rocm-cmake/build$ find /opt/rocm -name "ROCMConfig.cmake"
/opt/rocm/share/rocm/cmake/ROCMConfig.cmake
(rocm_env) redyy@redyy-NucBox-EVO-X2:~/rocm-libraries/projects/rocm-cmake/build$ 

cd ~/rocm-libraries/projects/composablekernel

# Inject gfx1151 into the supported list for GEMM Tile Ops
sed -i 's/gfx90a;gfx942;gfx950;gfx1201/gfx90a;gfx942;gfx950;gfx1201;gfx1151/g' tile_engine/ops/gemm/CMakeLists.txt
sed -i 's/gfx90a;gfx942;gfx950;gfx1201/gfx90a;gfx942;gfx950;gfx1201;gfx1151/g' test/ck_tile/gemm_tile_engine/CMakeLists.txt

# Inject gfx1151 into the FMHA supported list
sed -i 's/gfx9;gfx12/gfx9;gfx12;gfx1151/g' example/ck_tile/01_fmha/CMakeLists.txt

# Force gfx1151 into the FMHA (Flash Attention) support list
sed -i 's/gfx9;gfx12/gfx9;gfx12;gfx1151/g' example/ck_tile/01_fmha/CMakeLists.txt

# Force gfx1151 into the Multi-D GEMM and Preshuffle GEMM lists
sed -i 's/gfx90a;gfx942;gfx950/gfx90a;gfx942;gfx950;gfx1151/g' tile_engine/ops/gemm_multi_d/CMakeLists.txt
sed -i 's/gfx90a;gfx942;gfx950/gfx90a;gfx942;gfx950;gfx1151/g' tile_engine/ops/gemm_preshuffle/CMakeLists.txt

# 1. Update the main FMHA check to include gfx11 variants
sed -i 's/gfx9|gfx12/gfx9|gfx11|gfx12/g' example/ck_tile/01_fmha/CMakeLists.txt
sed -i 's/gfx9|gfx12/gfx9|gfx11|gfx12/g' test/ck_tile/fmha/CMakeLists.txt

# 2. Update the Tile Engine GEMM lists to explicitly allow gfx1151
sed -i 's/gfx1201/gfx1201;gfx1151/g' tile_engine/ops/gemm/CMakeLists.txt
sed -i 's/gfx1201/gfx1201;gfx1151/g' test/ck_tile/gemm_tile_engine/CMakeLists.txt
sed -i 's/gfx950)/gfx950;gfx1151)/g' tile_engine/ops/gemm_multi_d/CMakeLists.txt
sed -i 's/gfx950)/gfx950;gfx1151)/g' tile_engine/ops/gemm_preshuffle/CMakeLists.txt

# 3. Fix the broad checks in the top-level CMake
sed -i 's/gfx1[12]/gfx1/g' profiler/src/CMakeLists.txt

# 1. Fix the FMHA logical condition (The most critical part)
sed -i 's/MATCHES "gfx9|gfx12"/MATCHES "gfx9|gfx11|gfx12"/g' example/ck_tile/01_fmha/CMakeLists.txt
sed -i 's/MATCHES "gfx9|gfx12"/MATCHES "gfx9|gfx11|gfx12"/g' test/ck_tile/fmha/CMakeLists.txt

# 2. Fix the Tile Engine GEMM logical condition
# We look for where it checks against the list and force gfx1151 in
sed -i 's/MATCHES "gfx90a|gfx942|gfx950|gfx1201"/MATCHES "gfx90a|gfx942|gfx950|gfx1201|gfx1151"/g' tile_engine/ops/gemm/CMakeLists.txt
# This targets all .py files in the ops directory
# It inserts the gfx11-to-gfx12 factory bridge right before the Exception is raised
sed -i '/raise Exception(f"Unsupported device target {target}")/i \    if target.startswith("gfx11"):\n        return KernelComponentFactoryGfx12' example/ck_tile/01_fmha/codegen/ops/*.py
grep -nC 2 "return KernelComponentFactoryGfx12" example/ck_tile/01_fmha/codegen/ops/*.py

cd ~/rocm-libraries/projects/composablekernel/build
rm -rf *

cmake -G Ninja \
    -D CMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -D ROCM_DIR=/opt/rocm/share/rocm/cmake \
    -D CMAKE_CXX_COMPILER="/opt/rocm/llvm/bin/clang++" \
    -D CMAKE_C_COMPILER="/opt/rocm/llvm/bin/clang" \
    -D GPU_TARGETS="gfx1151" \
    -D CMAKE_BUILD_TYPE=Release \
    -D BUILD_DEV=OFF \
    -D BUILD_CK_TESTS=OFF \
    -D BUILD_CK_EXAMPLES=OFF \
    -D BUILD_CK_PROFILER=ON \
    ..

ninja -j$(nproc)


enum struct GemmMatrixLayout
{
    // MK_KN_MN, // 0
    MK_NK_MN = 1, // 1
                  // KM_KN_MN, // 2
                  // KM_NK_MN, // 3
};

enum struct GemmDataType
{
    F8_F8_F16  = 0, // 0
    F8_F8_BF16 = 1, // 1
    // F32_F32_F32,    // 0
    // F16_F16_F16,    // 1
    // BF16_BF16_BF16, // 2
    // INT8_INT8_INT8, // 3
    // F8_F16_F16,     // 4
    // F16_F8_F16,     // 5
    // F16_F16_F16_F8, // 6
    // F8_F8_BF16,     // 7
    // F16_I4_F16,     // 8
    // BF16_I4_BF16,   // 9

};

#define OP_NAME "gemm_universal_preshuffle"
#define OP_DESC "Universal GEMM Preshuffle"

int profile_gemm_universal_preshuffle(int argc, char* argv[])
{
#if defined(CK_USE_FP8_ON_UNSUPPORTED_ARCH) || CK_USE_OCP_FP8 || defined(CK_USE_GFX94) || \
    defined(CK_USE_WMMA_FP8)
    // --- TRUTH PATH: Logic exists only for supported hardware ---
    if(argc != 15 && argc != 18)
    {
        printf("arg1: tensor operation (gemm_universal_preshuffle)\n");
        printf("arg2: data type (0: f8->bf16, 1: f8->f16)\n");
        printf("arg3: layout (1: A[m, k] * B[n, k] = C[m, n])\n");
        printf("arg4: verification (0: no; 1: yes)\n");
        printf("arg5: initialization (0: no init; 1: integer; 2: decimal)\n");
        printf("arg6: print tensor value (0: no; 1: yes)\n");
        printf("arg7: time kernel (0=no, 1=yes)\n");
        printf("arg8 to 13: M, N, K, StrideA, StrideB, StrideC\n");
        printf("arg14: split k into multiple batch\n");
        printf("optional: arg15: warmup, arg16: iter, arg17: rotating buffer\n");
        exit(1);
    }

    int M       = std::stoi(argv[8]);
    int N       = std::stoi(argv[9]);
    int K       = std::stoi(argv[10]);
    int StrideA = std::stoi(argv[11]);
    int StrideB = std::stoi(argv[12]);
    int StrideC = std::stoi(argv[13]);
    int KBatch  = std::stoi(argv[14]);

    const auto data_type       = static_cast<GemmDataType>(std::stoi(argv[2]));
    const auto layout          = static_cast<GemmMatrixLayout>(std::stoi(argv[3]));
    const bool do_verification = std::stoi(argv[4]);
    const int init_method      = std::stoi(argv[5]);
    const bool do_log          = std::stoi(argv[6]);
    const bool time_kernel     = std::stoi(argv[7]);

    int n_warmup      = 1;
    int n_iter        = 10;
    uint64_t rotating = 0;
    if(argc == 18)
    {
        n_warmup = std::stoi(argv[15]);
        n_iter   = std::stoi(argv[16]);
        rotating = std::stoull(argv[17]) * 1024 * 1024;
    }

    using F32  = float;
    using F16  = ck::half_t;
    using BF16 = ck::bhalf_t;
    using F8   = ck::f8_t;
    using Row  = ck::tensor_layout::gemm::RowMajor;
    using Col  = ck::tensor_layout::gemm::ColumnMajor;

    auto profile = [&](auto a_type, auto b_type, auto comp_type, auto acc_type, auto c_type,
                       auto a_layout, auto b_layout, auto c_layout) {
        return ck::profiler::profile_gemm_universal_preshuffle_impl<
            decltype(a_type), decltype(b_type), decltype(comp_type), decltype(acc_type),
            decltype(c_type), decltype(a_layout), decltype(b_layout), decltype(c_layout)>(
            do_verification, init_method, do_log, time_kernel, M, N, K,
            StrideA, StrideB, StrideC, KBatch, n_warmup, n_iter, rotating) ? 0 : 1;
    };

    if(data_type == GemmDataType::F8_F8_F16 && layout == GemmMatrixLayout::MK_NK_MN)
        return profile(F8{}, F8{}, F16{}, F32{}, F16{}, Row{}, Col{}, Row{});
    
    if(data_type == GemmDataType::F8_F8_BF16 && layout == GemmMatrixLayout::MK_NK_MN)
        return profile(F8{}, F8{}, F8{}, F32{}, BF16{}, Row{}, Col{}, Row{});

#else
    // --- EXECUTIONER PATH: Hardware (gfx1151) has no truth here ---
    (void)argc;
    (void)argv;
#endif

    std::cout << "FP8 GEMM Preshuffle is NOT supported on gfx1151. Logical Corruption avoided." << std::endl;
    return 1;
}

REGISTER_PROFILER_OPERATION(OP_NAME, OP_DESC, profile_gemm_universal_preshuffle);

##
##
#include <iostream>
#include <numeric>
#include <initializer_list>
#include <cstdlib>

#include "profiler/profile_gemm_multiply_multiply_wp_impl.hpp"
#include "profiler_operation_registry.hpp"

enum struct GemmMatrixLayout
{
    MK_MFMA_MN, // 0
};

enum struct GemmDataType
{
    F8_F8_F16,  // 0
    F8_F8_BF16, // 1
};

#define OP_NAME "gemm_multiply_multiply_weight_preshuffle"
#define OP_DESC "GEMM_Multiply_Multiply_Weight_PreShuffle"

int profile_gemm_multiply_multiply_weight_preshuffle(int argc, char* argv[])
{
// Strictly restrict to architectures that actually possess these instances
#if defined(CK_USE_GFX94)
    if(argc != 16 && argc != 20)
    {
        printf("arg1: tensor operation (" OP_NAME ": " OP_DESC ")\n");
        printf("arg2: data type (0: f8->f16; 1: f8->bf16;\n");
        printf("arg3: matrix layout (0: A[m, k] * B[MFMA] = C[m, n];\n");
        printf("arg4: verification (0: no; 1: yes)\n");
        printf("arg5: initialization (0: no init; 1: integer value; 2: decimal value)\n");
        printf("arg6: print tensor value (0: no; 1: yes)\n");
        printf("arg7: time kernel (0=no, 1=yes)\n");
        printf("arg8 to 15: M, N, K, StrideA, StrideB, StrideD0, StrideD1, StrideE\n");
        printf("optional:\n");
        printf("arg16: number of kbatch (default 1)\n");
        printf("arg17: number of warm-up cycles (default 1)\n");
        printf("arg18: number of iterations (default 10)\n");
        printf("arg19: memory for rotating buffer (default 0, size in MB)\n");
        exit(1);
    }

    const auto data_type       = static_cast<GemmDataType>(std::stoi(argv[2]));
    const auto layout          = static_cast<GemmMatrixLayout>(std::stoi(argv[3]));
    const bool do_verification = std::stoi(argv[4]);
    const int init_method      = std::stoi(argv[5]);
    const bool do_log          = std::stoi(argv[6]);
    const bool time_kernel     = std::stoi(argv[7]);

    const int M = std::stoi(argv[8]);
    const int N = std::stoi(argv[9]);
    const int K = std::stoi(argv[10]);

    const int StrideA  = std::stoi(argv[11]);
    const int StrideB  = std::stoi(argv[12]);
    const int StrideD0 = std::stoi(argv[13]);
    const int StrideD1 = std::stoi(argv[14]);
    const int StrideE  = std::stoi(argv[15]);

    int n_warmup      = 1;
    int n_iter        = 10;
    uint64_t rotating = 0;
    int KBatch        = 1;
    if(argc == 20)
    {
        KBatch   = std::stoi(argv[16]);
        n_warmup = std::stoi(argv[17]);
        n_iter   = std::stoi(argv[18]);
        rotating = std::stoull(argv[19]) * 1024 * 1024;
    }

    using F32  = float;
    using BF16 = ck::bhalf_t;
    using F16  = ck::half_t;
    using F8   = ck::f8_t;

    using Row = ck::tensor_layout::gemm::RowMajor;
    using Col = ck::tensor_layout::gemm::ColumnMajor;

    auto profile = [&](auto a_type, auto b_type, auto comp_type, auto acc_type,
                       auto d0_type, auto d1_type, auto c_type,
                       auto a_layout, auto b_layout, auto d0_layout, auto d1_layout, auto e_layout) {
        return ck::profiler::profile_gemm_multiply_multiply_weight_preshuffle_impl<
            decltype(a_type), decltype(b_type), decltype(comp_type), decltype(acc_type),
            decltype(d0_type), decltype(d1_type), decltype(c_type),
            decltype(a_layout), decltype(b_layout), decltype(d0_layout), decltype(d1_layout), decltype(e_layout)>(
            do_verification, init_method, do_log, time_kernel, M, N, K,
            (StrideA < 0) ? (ck::is_same_v<decltype(a_layout), Row> ? K : M) : StrideA,
            (StrideB < 0) ? (ck::is_same_v<decltype(b_layout), Row> ? N : K) : StrideB,
            (StrideD0 < 0) ? (ck::is_same_v<decltype(d0_layout), Row> ? N : M) : StrideD0,
            (StrideD1 < 0) ? (ck::is_same_v<decltype(d1_layout), Row> ? N : M) : StrideD1,
            (StrideE < 0) ? (ck::is_same_v<decltype(e_layout), Row> ? N : M) : StrideE,
            KBatch, n_warmup, n_iter, rotating);
    };

    if(data_type == GemmDataType::F8_F8_F16 && layout == GemmMatrixLayout::MK_MFMA_MN)
        return profile(F8{}, F8{}, F8{}, F32{}, F32{}, F32{}, F16{}, Row{}, Col{}, Row{}, Col{}, Row{}) ? 0 : 1;
    
    if(data_type == GemmDataType::F8_F8_BF16 && layout == GemmMatrixLayout::MK_MFMA_MN)
        return profile(F8{}, F8{}, F8{}, F32{}, F32{}, F32{}, BF16{}, Row{}, Col{}, Row{}, Col{}, Row{}) ? 0 : 1;

    std::cout << "Data type & layout not supported." << std::endl;
    return 1;
#else
    // Absolute Sovereignty: incinerate logic for gfx1151
    (void)argc;
    (void)argv;
    std::cout << OP_NAME << " is NOT supported on gfx1151." << std::endl;
    return 0;
#endif
}

REGISTER_PROFILER_OPERATION(OP_NAME, OP_DESC, profile_gemm_multiply_multiply_weight_preshuffle);

##
##
# 1. Purge the ghost references from the newly generated Ninja files
sed -i 's/-ldevice_gemm_multiply_multiply_wp_instance//g' build.ninja
sed -i 's/-ldevice_gemm_universal_preshuffle_instance//g' build.ninja

find profiler/src -name "build.ninja" -exec sed -i 's/-ldevice_gemm_multiply_multiply_wp_instance//g' {} +
find profiler/src -name "build.ninja" -exec sed -i 's/-ldevice_gemm_universal_preshuffle_instance//g' {} +

# 2. Re-run Ninja. It will now finish 100% because the friction is gone.
ninja -j$(nproc)
sudo ninja install
##














































































































































































































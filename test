git checkout -f tags/rocm-7.2.0 -B rocm-7.2.0-stable
git clean -ffdx
git submodule update --init --recursive
grep -r "FeatureAtomicFaddInsts" llvm/lib/Target/AMDGPU/

grep -r "gfx1151" llvm/lib/Target/AMDGPU/
grep -r "gfx1151" mlir/lib/Dialect/GPU/

#
cd ~/llvm-project
rm -rf build
mkdir build && cd build
#
cd ~/llvm-project/build
rm -rf *

export CC=/usr/bin/gcc-14
export CXX=/usr/bin/g++-14

# Standard ROCm Ecosystem expects the compiler at /opt/rocm/llvm
cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=OFF \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_INSTALL_UTILS=ON 
 
# Execute with immediate panic on failure
ninja -j$(nproc) && sudo ninja install

##
cd ~/llvm-project/amd/device-libs
rm -rf build && mkdir build && cd build

# Use your newly installed LLVM as the Executioner
cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DAMDGCN_TARGETS="gfx1151" \
    -DBUILD_HC_LIB=ON

ninja && sudo ninja install
##
cd ~/llvm-project/amd/comgr
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DAMD_COMGR_GFX_ARCHS="gfx1151"

ninja && sudo ninja install
##
cd ~/llvm-project/amd/hipcc
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm

ninja && sudo ninja install
##
cd ~/rocm-systems/projects/ROCT-Thunk-Interface
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DBUILD_SHARED_LIBS=ON

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocr-runtime
# Delete old failed state
rm -rf build && mkdir build && cd build

# Link to the ROCT (Thunk) we just installed in /opt/rocm
cmake -G "Ninja" .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DIMAGE_SUPPORT=ON

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocminfo
rm -rf build && mkdir build && cd build
cmake -G "Ninja" .. -DCMAKE_INSTALL_PREFIX=/opt/rocm -DCMAKE_PREFIX_PATH=/opt/rocm
ninja && sudo ninja install

# IMMEDIATE AUDIT:
/opt/rocm/bin/rocminfo | grep "gfx1151"
##
cd ~/rocm-systems/projects/rocm-smi-lib
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja && sudo ninja install
##
pip install CppHeaderParser
cd ~/rocm-systems/projects/rocprofiler-register
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/clr/build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/lib;/opt/rocm/lib64" \
    -DCLR_BUILD_HIP=ON \
    -DCLR_BUILD_OCL=ON \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCMAKE_BUILD_TYPE=Release \
    -DHIP_ENABLE_PCH=OFF

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/roctracer
rm -rf build && mkdir build && cd build

# Disable tests and build only the core sovereignty
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm \
    -DBUILD_TESTS=OFF \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
# Locate your COMGR source. It is usually in 'clr' or a standalone folder.
# If it's in the projects list:
cd ~/rocm-systems/projects/amd_comgr 
# If it's not there, it might be in ~/rocm-systems/projects/clr/opencl/amdocl/comgr
# Find it first: find ~/rocm-systems/projects -name "CMakeLists.txt" | grep comgr

rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm/llvm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DClang_DIR=/opt/rocm/llvm/lib/cmake/clang \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/amdsmi
rm -rf build && mkdir build && cd build

# We point to the local LLVM and the new COMGR to ensure no Ghost Logic
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
GPU: 0
    ASIC:
        MARKET_NAME: AMD Radeon Graphics
        VENDOR_ID: 0x1002
        VENDOR_NAME: Advanced Micro Devices Inc. [AMD/ATI]
        SUBVENDOR_ID: 0x2014
        DEVICE_ID: 0x1586
        SUBSYSTEM_ID: 0x801d
        REV_ID: 0xc1
        ASIC_SERIAL: 0x0000000000000000
        OAM_ID: N/A
        NUM_COMPUTE_UNITS: 40
        TARGET_GRAPHICS_VERSION: gfx1151
    BUS:
        BDF: 0000:c5:00.0
        MAX_PCIE_WIDTH: N/A
        MAX_PCIE_SPEED: N/A
        PCIE_LEVELS: N/A
        PCIE_INTERFACE_VERSION: N/A
        SLOT_TYPE: N/A
    IFWI:
        NAME: AMD STRIX_HALO_GENERIC
        BUILD_DATE: 2024/06/17 02:08
        PART_NUMBER: 113-STRXLGEN-001
        VERSION: 023.011.000.039.000001
    LIMIT:
        PPT0:
            MAX_POWER_LIMIT: N/A
            MIN_POWER_LIMIT: N/A
            SOCKET_POWER_LIMIT: N/A
        PPT1:
            MAX_POWER_LIMIT: N/A
            MIN_POWER_LIMIT: N/A
            SOCKET_POWER_LIMIT: N/A
        SLOWDOWN_EDGE_TEMPERATURE: N/A
        SLOWDOWN_HOTSPOT_TEMPERATURE: N/A
        SLOWDOWN_VRAM_TEMPERATURE: N/A
        SHUTDOWN_EDGE_TEMPERATURE: N/A
        SHUTDOWN_HOTSPOT_TEMPERATURE: N/A
        SHUTDOWN_VRAM_TEMPERATURE: N/A
        PTL_STATE: N/A
        PTL_FORMAT: N/A
    DRIVER:
        NAME: amdgpu
        VERSION: Linuxversion6.17.0-14-generic(buildd@lcy02-amd64-067)(x86_64-linux-gnu-gcc-13(Ubuntu13.3.0-6ubuntu2~24.04)13.3.0,GNUld(GNUBinutilsforUbuntu)2.42)#14~24.04.1-UbuntuSMPPREEMPT_DYNAMICThuJan1515:52:10UTC2
    BOARD:
        MODEL_NUMBER: N/A
        PRODUCT_SERIAL: N/A
        FRU_ID: N/A
        PRODUCT_NAME: N/A
        MANUFACTURER_NAME: Advanced Micro Devices, Inc. [AMD/ATI]
    RAS:
        EEPROM_VERSION: N/A
        BAD_PAGE_THRESHOLD: N/A
        BAD_PAGE_THRESHOLD_EXCEEDED: N/A
        PARITY_SCHEMA: N/A
        SINGLE_BIT_SCHEMA: N/A
        DOUBLE_BIT_SCHEMA: N/A
        POISON_SCHEMA: N/A
        ECC_BLOCK_STATE: N/A
    SOC_PSTATE: N/A
    XGMI_PLPD: N/A
    PROCESS_ISOLATION: Disabled
    NUMA:
        NODE: 0
        AFFINITY: NONE
        CPU_AFFINITY: N/A
        SOCKET_AFFINITY: N/A
    VRAM:
        TYPE: GDDR7
        VENDOR: UNKNOWN
        SIZE: 32768 MB
        BIT_WIDTH: 256
        MAX_BANDWIDTH: N/A 
    CACHE_INFO:
        CACHE_0:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 32 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 1
            NUM_CACHE_INSTANCE: 40
        CACHE_1:
            CACHE_PROPERTIES: INST_CACHE, SIMD_CACHE
            CACHE_SIZE: 32 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 2
            NUM_CACHE_INSTANCE: 20
        CACHE_2:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 16 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 2
            NUM_CACHE_INSTANCE: 20
        CACHE_3:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 256 KB
            CACHE_LEVEL: 1
            MAX_NUM_CU_SHARED: 10
            NUM_CACHE_INSTANCE: 4
        CACHE_4:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 2048 KB
            CACHE_LEVEL: 2
            MAX_NUM_CU_SHARED: 40
            NUM_CACHE_INSTANCE: 1
        CACHE_5:
            CACHE_PROPERTIES: DATA_CACHE, SIMD_CACHE
            CACHE_SIZE: 32768 KB
            CACHE_LEVEL: 3
            MAX_NUM_CU_SHARED: 40
            NUM_CACHE_INSTANCE: 1
    CLOCK:
        SYS:
            CURRENT_LEVEL: 1
            CURRENT_FREQUENCY: 829MHz
            FREQUENCY_LEVELS:
                LEVEL 0: 600 MHz
                LEVEL 1: 829 MHz
                LEVEL 2: 2900 MHz
        MEM: N/A
        DF: N/A
        SOC: N/A
        DCEF: N/A
        VCLK0: N/A
        VCLK1: N/A
        DCLK0: N/A
        DCLK1: N/A
##
cd ~/rocm-systems/projects/HIPIFY
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/rocm-smi-lib
rm -rf build && mkdir build && cd build

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/rocm-systems/projects/HIPIFY
rm -rf build && mkdir build && cd build

# We bind it to your LLVM 22 and the /opt/rocm prefix.
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install

/opt/rocm/bin/hipify-perl --help
# And the binary version
/opt/rocm/bin/hipify-clang --version

    hipify-perl is a tool to translate CUDA source code into portable HIP C++

    USAGE: hipify-perl [OPTIONS] INPUT_FILE

    OPTIONS:

      -cuda-kernel-execution-syntax - Keep CUDA kernel launch syntax (default)
      -examine                      - Combines -no-output and -print-stats options
      -exclude-dirs=s               - Exclude directories
      -exclude-files=s              - Exclude files
      -experimental                 - HIPIFY experimentally supported APIs
      -help                         - Display available options
      -hip-kernel-execution-syntax  - Transform CUDA kernel launch syntax to a regular HIP function call (overrides "--cuda-kernel-execution-syntax")
      -inplace                      - Backup the input file in .prehip file, modify the input file inplace
      -miopen                       - Translate cuDNN to MIOpen instead of hipDNN where it is possible
      -no-output                    - Don't write any translated output to stdout
      -o=s                          - Output filename
      -print-stats                  - Print translation statistics
      -quiet-warnings               - Don't print warnings on unknown CUDA identifiers
      -roc                          - Translate to roc instead of hip where it is possible
      -version                      - The supported HIP version
      -whitelist=s                  - Whitelist of identifiers

AOMP-18.0-12 (http://github.com/ROCm/aomp):
 Source ID:18.0-12-ce1873ac686bb90ddec72bb99889a4e80e2de382
  LLVM version 22.0.0git
  Optimized build with assertions.
##
cd ~/rocm-systems/projects/clr/build
rm -rf *

# We use $(realpath ...) to ensure the paths are Absolute Truth, not tildes.
# We disable the PCH (Pre-compiled header) to bypass the 'max' vs 'fmax' LLVM 22 conflict.
cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH="/opt/rocm;/opt/rocm/llvm" \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DCLR_BUILD_HIP=ON \
    -DCLR_BUILD_OCL=ON \
    -DHIP_COMMON_DIR=$(realpath ../../hip) \
    -DCPACK_PACKAGING_INSTALL_PREFIX=/opt/rocm \
    -DHIP_PLATFORM=amd \
    -DBUILD_HIP_PCH=OFF \
    -DCMAKE_BUILD_TYPE=Release

ninja
sudo ninja install
##
cd ~/llvm-project/amd/comgr/build
rm -rf *

cmake -G "Ninja" .. \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DCMAKE_PREFIX_PATH=/opt/rocm/llvm \
    -DCMAKE_CXX_COMPILER=/opt/rocm/llvm/bin/clang++ \
    -DCMAKE_C_COMPILER=/opt/rocm/llvm/bin/clang \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DCOMGR_LLVM_LINK_STATIC=ON

ninja
sudo ninja install
nm -D /opt/rocm/lib/libamd_comgr.so.3 | grep "finalizeLLVMOptimizationRemarks"
FAILED

NucBox-EVO-X2:~/llvm-project$ grep -r "finalizeLLVMOptimizationRemarks" llvm/lib llvm/include
llvm/lib/IR/LLVMRemarkStreamer.cpp:  finalizeLLVMOptimizationRemarks(*Context);
llvm/lib/IR/LLVMRemarkStreamer.cpp:void llvm::finalizeLLVMOptimizationRemarks(LLVMContext &Context) {
llvm/include/llvm/IR/LLVMRemarkStreamer.h:/// finalizeLLVMOptimizationRemarks() is called before the file is destroyed or
llvm/include/llvm/IR/LLVMRemarkStreamer.h:/// \ref finalizeLLVMOptimizationRemarks() is called.
llvm/include/llvm/IR/LLVMRemarkStreamer.h:LLVM_ABI void finalizeLLVMOptimizationRemarks(LLVMContext &Context);

[192/193] Install the project...
-- Install configuration: "Release"
-- Installing: /opt/rocm/lib/libamd_comgr.so.3.0.0
-- Up-to-date: /opt/rocm/lib/libamd_comgr.so.3
-- Set non-toolchain portion of runtime path of "/opt/rocm/lib/libamd_comgr.so.3.0.0" to ""
-- Up-to-date: /opt/rocm/lib/libamd_comgr.so
-- Installing: /opt/rocm/include/amd_comgr/amd_comgr.h
-- Up-to-date: /opt/rocm/share/doc/amd_comgr/README.md
-- Up-to-date: /opt/rocm/share/doc/amd_comgr/LICENSE.txt
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-config.cmake
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-targets.cmake
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-targets-release.cmake
-- Installing: /opt/rocm/lib/cmake/amd_comgr/amd_comgr-config-version.cmake
NucBox-EVO-X2:~/llvm-project/amd/comgr/build$ nm -D /opt/rocm/lib/libamd_comgr.so.3 | grep "finalizeLLVMOptimizationRemarks"
                 U _ZN4llvm31finalizeLLVMOptimizationRemarksERNS_11LLVMContextE@LLVM_22.0
NucBox-EVO-X2:~/llvm-project/amd/comgr/build$ find . -name "*.o" | xargs nm -C | grep "finalizeLLVMOptimizationRemarks"
nm: ./test/source/double.o: file format not recognized
NucBox-EVO-X2:~/llvm-project/amd/comgr/build$ 

##
cd ~/llvm-project/build
rm -rf *

cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=OFF \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_DYLIB_EXPORT_ALL=ON \
    -DLLVM_BUILD_REMARKS=ON \
    -DLLVM_ENABLE_ZLIB=ON \
    -DLLVM_ENABLE_ZSTD=ON \
    -DLLVM_DISTRIBUTION_COMPONENTS="llvm-libraries;clang;lld;LTO;Remarks"

NucBox-EVO-X2:~/llvm-project/build$ nm -D /opt/rocm/llvm/lib/libLLVM.so | grep "finalizeLLVMOptimizationRemarks"
0000000000c04560 T _ZN4llvm31finalizeLLVMOptimizationRemarksERNS_11LLVMContextE@@LLVM_22.0
NucBox-EVO-X2:~/llvm-project/build$ nm -D /opt/rocm/lib/libamd_comgr.so | grep "finalizeLLVMOptimizationRemarks"
                 U _ZN4llvm31finalizeLLVMOptimizationRemarksERNS_11LLVMContextE@LLVM_22.0
NucBox-EVO-X2:~/llvm-project/build$ ldd /opt/rocm/lib/libamd_comgr.so | grep libLLVM
        libLLVM.so.22.0git => /opt/rocm/llvm/lib/libLLVM.so.22.0git (0x000079cfe1c00000)
NucBox-EVO-X2:~/llvm-project/build$ echo "/opt/rocm/llvm/lib" | sudo tee /etc/ld.so.conf.d/rocm-llvm.conf
/opt/rocm/llvm/lib
NucBox-EVO-X2:~/llvm-project/build$ sudo ldconfig
NucBox-EVO-X2:~/llvm-project/build$ ldconfig -p | grep libLLVM.so.22.0git
        libLLVM.so.22.0git (libc6,x86-64) => /opt/rocm/llvm/lib/libLLVM.so.22.0git

##
git submodule update --init --recursive
mkdir -p build && cd build
cmake -G Ninja .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_PREFIX_PATH="/opt/rocm/llvm;/opt/rocm" \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm \
    -DROCM_PATH=/opt/rocm \
    -DLLVM_DIR=/opt/rocm/llvm/lib/cmake/llvm \
    -DMLIR_DIR=/opt/rocm/llvm/lib/cmake/mlir \
    -DROCMLIR_DRIVER_PRIMITIVE_TARGETS="gfx1151" \
    -DBUILD_FAT_LIBROCMLIR=ON
ninja
sudo ninja install

# Inside ~/rocm-systems/projects/rocMLIR/build
cmake -G Ninja .. [flags from before]
ninja
sudo ninja install

# Inside your (rocm_env)
pip install -r ../pip_requirements.txt

NucBox-EVO-X2:~/rocm-systems/projects/rocMLIR/build$ ldd -r /opt/rocm/bin/rocmlir-driver 2>&1 | grep "undefined symbol"
undefined symbol: _ZN4mlir29registerGPUDialectTranslationERNS_15DialectRegistryE        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir30registerLLVMDialectTranslationERNS_15DialectRegistryE       (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld3elf4linkEN4llvm8ArrayRefIPKcEERNS1_11raw_ostreamES7_bb        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld19CommonLinkerContext7destroyEv        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesENS0_33MathExtendToSupportedTypesOptionsE        (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassENS_34ArithToAMDGPUConversionPassOptionsE    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir22createTosaToTensorPassEv    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassENS0_31AmdgpuEmulateAtomicsPassOptionsE  (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math21createMathUpliftToFMAEv        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir13bufferization33registerTransformDialectExtensionERNS_15DialectRegistryE       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu32createAmdgpuMaskedloadToLoadPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir5index35registerConvertIndexToLLVMInterfaceERNS_15DialectRegistryE    (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu38createAmdgpuResolveStridedMetadataPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6tensor42registerInferTypeOpInterfaceExternalModelsERNS_15DialectRegistryE      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir2ub32registerConvertUBToLLVMInterfaceERNS_15DialectRegistryE  (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir37registerConvertComplexToLLVMInterfaceERNS_15DialectRegistryE        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math23createMathExpandOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math26createMathSincosFusionPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu29createAmdgpuFoldMemRefOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassEv (/opt/rocm/bin/rocmlir-driver)
NucBox-EVO-X2:~/rocm-systems/projects/rocMLIR/build$ 

Failed.
##
cd ~/llvm-project/build
rm -rf *

cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=OFF \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=OFF \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DMLIR_BUILD_MLIR_DYLIB=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_DYLIB_EXPORT_ALL=ON \
    -DLLVM_BUILD_REMARKS=ON \
    -DLLVM_ENABLE_ZLIB=ON \
    -DLLVM_ENABLE_ZSTD=ON \
    -DLLVM_DISTRIBUTION_COMPONENTS="llvm-libraries;clang;lld;LTO;Remarks;mlir-libraries;mlir-cmake-exports"

ninja -j$(nproc) && sudo ninja install

You only need to re-build LLVM if:
    Version Mismatch: You need a newer version of LLVM (e.g., moving from 22.0 to 23.0).
    Missing Project: You suddenly need a project you didn't include (e.g., you decided you needed Polly).
    Broken Exports: You find a "Ghost Symbol" (like you just did) because a flag was missing.

ldd -r /opt/rocm/bin/rocmlir-driver 2>&1 | grep "undefined symbol"
NucBox-EVO-X2:~$ ldd -r /opt/rocm/bin/rocmlir-driver 2>&1 | grep "undefined symbol"
undefined symbol: _ZN4mlir29registerGPUDialectTranslationERNS_15DialectRegistryE        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir30registerLLVMDialectTranslationERNS_15DialectRegistryE       (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld3elf4linkEN4llvm8ArrayRefIPKcEERNS1_11raw_ostreamES7_bb        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN3lld19CommonLinkerContext7destroyEv        (/opt/rocm/lib/libMLIRRocTarget.so.2.0)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesENS0_33MathExtendToSupportedTypesOptionsE        (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassENS_34ArithToAMDGPUConversionPassOptionsE    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir22createTosaToTensorPassEv    (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassENS0_31AmdgpuEmulateAtomicsPassOptionsE  (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/lib/libMLIRRockPipeline.so.2.0)
undefined symbol: _ZN4mlir4math21createMathUpliftToFMAEv        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir13bufferization33registerTransformDialectExtensionERNS_15DialectRegistryE       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu32createAmdgpuMaskedloadToLoadPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir5index35registerConvertIndexToLLVMInterfaceERNS_15DialectRegistryE    (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu38createAmdgpuResolveStridedMetadataPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir21createTosaToArithPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir19createTosaToSCFPassEv       (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6tensor42registerInferTypeOpInterfaceExternalModelsERNS_15DialectRegistryE      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir2ub32registerConvertUBToLLVMInterfaceERNS_15DialectRegistryE  (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir37registerConvertComplexToLLVMInterfaceERNS_15DialectRegistryE        (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math23createMathExpandOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu30createAmdgpuEmulateAtomicsPassEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math26createMathSincosFusionPassEv   (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir6amdgpu29createAmdgpuFoldMemRefOpsPassEv      (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir4math32createMathExtendToSupportedTypesEv     (/opt/rocm/bin/rocmlir-driver)
undefined symbol: _ZN4mlir33createArithToAMDGPUConversionPassEv (/opt/rocm/bin/rocmlir-driver)
FAILED.
##
cd ~/llvm-project/build
rm -rf *
unset FC
unset F90

cmake -G "Ninja" ../llvm \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/rocm/llvm \
    -DLLVM_ENABLE_PROJECTS="clang;lld;mlir;clang-tools-extra;flang;lldb;polly;bolt" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind;openmp" \
    -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" \
    -DAMDGPU_TARGETS="gfx1151" \
    -DCLANG_OFFLOAD_DEFAULT_DEVICE=amdgcn-amd-amdhsa \
    -DLIBOMPTARGET_DEVICE_ARCHS="gfx1151" \
    -DLIBOMPTARGET_AMDGCN_GFXLIST="gfx1151" \
    -DROCM_PATH=/opt/rocm \
    -DHIP_PATH=/opt/rocm \
    -DDEFAULT_SYSROOT=/opt/rocm \
    -DCLANG_DEFAULT_ROCM_DEVICE_LIB_PATH=/opt/rocm/amdgpu/lib \
    -DROCM_DEVICE_LIB_DIR="/opt/rocm/amdgpu/lib" \
    -DDEVICE_LIBS_LIB_DIR="/opt/rocm/amdgpu/lib" \
    -DAMD_DEVICE_LIBS_PREFIX=/opt/rocm \
    -DHIP_PLATFORM=amd \
    -DCLANG_ENABLE_HIP=ON \
    -DLIBOMPTARGET_ENABLE_AMDGPU=ON \
    -DAMDGPU_TARGETS_TO_BUILD="gfx1151" \
    -DCLANG_DEFAULT_LINKER=lld \
    -DCLANG_DEFAULT_OBJCOPY=llvm-objcopy \
    -DLLVM_AMDGPU_ALLOW_ALL=ON \
    -DMLIR_NVVM_EMBED_LIBDEVICE=ON \
    -DLLVM_DEFAULT_TARGET_TRIPLE=amdgcn-amd-amdhsa \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_BUILD_MLIR_DYLIB=ON \
    -DMLIR_BUILD_MLIR_C_DYLIB=ON \
    -DMLIR_LINK_MLIR_DYLIB=ON \
    -DMLIR_ENABLE_AGGREGATE_OBJECTS=ON \
    -DMLIR_INSTALL_AGGREGATE_OBJECTS=ON \
    -DMLIR_EXPORT_DYNAMIC_SYMBOLS=ON \
    -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
    -DMLIR_ENABLE_ROCM_RUNNER=ON \
    -DMLIR_ENABLE_CUDA_RUNNER=OFF \
    -DMLIR_ENABLE_CUDA_CONVERSIONS=OFF \
    -DMLIR_ENABLE_VULKAN_RUNNER=OFF \
    -DMLIR_ENABLE_SPIRV_CPU_RUNNER=OFF \
    -DMLIR_ENABLE_SYCL_RUNNER=OFF \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_PYTHON_BINDINGS_VERSION_LOCKED=ON \
    -DPython3_EXECUTABLE=$(which python3) \
    -DMLIR_ENABLE_PDL_IN_PATTERNMATCH=ON \
    -DMLIR_ENABLE_EXPENSIVE_PATTERN_API_CHECKS=ON \
    -DMLIR_INCLUDE_TESTS=OFF \
    -DMLIR_INCLUDE_INTEGRATION_TESTS=OFF \
    -DMLIR_ENABLE_NVPTXCOMPILER=OFF \
    -DMLIR_ENABLE_LEVELZERO_RUNNER=OFF \
    -DMLIR_ROCM_RUNNER_ENABLED=ON \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_DYLIB_EXPORT_ALL=ON \
    -DCMAKE_C_FLAGS="-O3 -march=native" \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DCMAKE_ASM_FLAGS="-O3 -march=native" \
    -DCMAKE_ASM_COMPILER_WORKS=ON \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_EH=ON \
    -DLLVM_ENABLE_LTO=OFF \
    -DLLVM_BUILD_REMARKS=ON \
    -DLLVM_ENABLE_Z3_SOLVER=OFF \
    -DLLVM_ENABLE_ZLIB=ON \
    -DLLVM_ENABLE_ZSTD=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
    -DLLVM_AMDGPU_NEXT_GEN_COMPILER=ON \
    -DCMAKE_VISIBILITY_INLINES_HIDDEN=OFF \
    -DLLVM_TOOL_LLD_BUILD=ON \
    -DCLANG_DEFAULT_RTLIB="compiler-rt" \
    -DCLANG_DEFAULT_UNWINDLIB="libunwind" \
    -DLLVM_ENABLE_CUDA=OFF \
    -DCLANG_ENABLE_CUDA=OFF \
    -DCMAKE_Fortran_COMPILER=OFF \
    -DFLANG_INCLUDE_TESTS=OFF \
    -DFLANG_BUILD_EXAMPLES=OFF \
    -DCMAKE_POLICY_DEFAULT_CMP0146=OLD 
    
ninja -j$(nproc) 
sudo rm -rf /opt/rocm/llvm
sudo mkdir -p /opt/rocm/llvm
sudo ninja install

##

CMake Generate step failed.  Build files cannot be regenerated correctly.
NucBox-EVO-X2:~/llvm-project/amd/device-libs/build$ ls $LLVM_PATH/bin/llvm-link
ls $LLVM_PATH/lib/cmake/llvm/LLVMConfig.cmake
/opt/rocm/llvm/bin/llvm-link
/opt/rocm/llvm/lib/cmake/llvm/LLVMConfig.cmake

cd build
rm -rf *

cmake -G "Ninja" .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/opt/rocm \
  -DCMAKE_PREFIX_PATH="$LLVM_PATH" \
  -DLLVM_DIR="$LLVM_PATH/lib/cmake/llvm" \
  -DCMAKE_C_COMPILER="$LLVM_PATH/bin/clang" \
  -DCMAKE_CXX_COMPILER="$LLVM_PATH/bin/clang++"

##

# --- 1. ROCm & LLVM Path Sovereignty ---
# The Absolute Truth: /opt/rocm is the Root, /opt/rocm/llvm is the Executioner
export ROCM_PATH=/opt/rocm
export LLVM_PATH=/opt/rocm/llvm
# --- 1.1 Path Sovereignty Gatekeepers ---
# Verify ROCm Root (The Foundation)
[ ! -d "$ROCM_PATH" ] && { 
    echo -e "\e[1;31m!!! [FATAL] ROCM_PATH MISSING: $ROCM_PATH\e[0m"; 
    echo "Truth: The hardware substrate is not installed."; 
    exit 1; 
}
# Verify LLVM Path (The Executioner)
# Note: If this is your first build, manually run 'sudo mkdir -p /opt/rocm/llvm' first.
[ ! -d "$LLVM_PATH" ] && { 
    echo -e "\e[1;31m!!! [FATAL] LLVM_PATH MISSING: $LLVM_PATH\e[0m"; 
    echo "Truth: The compiler output territory has not been established."; 
    exit 1; 
}
echo ">>> [SYSTEM] Sovereignty Verified: Roots and Executioners are present."
# Hierarchy: Prioritize your custom standard-build tools
export PATH=$LLVM_PATH/bin:$ROCM_PATH/bin:$PATH
# --- PATH Sovereignty Verification ---
# Rule 1: No Vacuums. If the variables are empty, the system must perish.
if [ -z "$LLVM_PATH" ] || [ -z "$ROCM_PATH" ]; then
    echo -e "\e[1;31m!!! [FATAL] Environment Vacuum Detected.\e[0m"
    echo "Reason: LLVM_PATH or ROCM_PATH is undefined."
    exit 1
fi
# Rule 2: No Ghost Paths. If the physical binaries are missing, the executioner cannot strike.
if [ ! -d "$LLVM_PATH/bin" ]; then
    echo -e "\e[1;31m!!! [FATAL] LLVM Binaries Missing: $LLVM_PATH/bin\e[0m"
    exit 1
fi
if [ ! -d "$ROCM_PATH/bin" ]; then
    echo -e "\e[1;31m!!! [FATAL] ROCm Binaries Missing: $ROCM_PATH/bin\e[0m"
    exit 1
fi
# Hierarchy: Prioritize your custom standard-build tools
export PATH=$LLVM_PATH/bin:$ROCM_PATH/bin:$PATH
echo ">>> [PATH] Hierarchy Established. Executioners at the front."

# REMOVE the GCC-14 path. Clang knows how to find its own runtimes.
export LD_LIBRARY_PATH=$LLVM_PATH/lib:$ROCM_PATH/lib:$LD_LIBRARY_PATH
# --- LD_LIBRARY_PATH Sovereignty Check ---
# 1. Check for LLVM Library Reality
if [ ! -d "$LLVM_PATH/lib" ]; then
    echo -e "\e[1;31m!!! [FATAL] LLVM Library Path Missing: $LLVM_PATH/lib\e[0m"
    echo "Reason: Shared objects (.so) are not present. Sequential Causality broken."
    exit 1
fi
# 2. Check for ROCm Library Reality
if [ ! -d "$ROCM_PATH/lib" ]; then
    echo -e "\e[1;31m!!! [FATAL] ROCm Library Path Missing: $ROCM_PATH/lib\e[0m"
    echo "Reason: Hardware acceleration libraries not found."
    exit 1
fi
# 3. Hierarchy: Enforce Custom Paths as the One-Way Vector of Truth
export LD_LIBRARY_PATH=$LLVM_PATH/lib:$ROCM_PATH/lib:$LD_LIBRARY_PATH
echo ">>> [LINKER] Library Sovereignty Established. Ghost paths eliminated."

# --- 2. AMD 8060S (gfx1151) Hardware Identity ---
# Direct mapping to the silicon truth
export HSA_OVERRIDE_GFX_VERSION=11.5.1
export HCC_AMDGPU_TARGET=gfx1151
export PYTORCH_ROCM_ARCH=gfx1151
export HIP_PLATFORM=amd
export HIP_RUNTIME=amd
export HIP_COMPILER=clang

# This is where ROCm-Device-Libs MUST be installed for Clang to see them
export DEVICE_LIB_PATH=/opt/rocm/amdgpu/lib
OCML_CHECK=$(find "$DEVICE_LIB_PATH" -name "ocml.bc" 2>/dev/null)
if [ -z "$OCML_CHECK" ]; then
    echo -e "\e[1;31m[ERROR 01: BITCODE MISSING]\e[0m"
    echo "Location: $DEVICE_LIB_PATH"
    echo "Reason: The silicon instructions (ocml.bc) are not present at the defined path."
    echo "Fix: Check if 'rocm-device-libs' is installed or if the path is wrong."
    exit 1 
fi
# --- 1.6 Hardware Substrate Verification ---
AMDGPU_ARCH_BIN="$LLVM_PATH/bin/amdgpu-arch"
if [ -f "$AMDGPU_ARCH_BIN" ]; then
    DETECTED_ARCH=$($AMDGPU_ARCH_BIN | head -n 1)
    
    if [[ "$DETECTED_ARCH" != *"gfx1151"* ]]; then
        echo -e "\e[1;31m[ERROR 02: HARDWARE MISMATCH]\e[0m"
        echo "Detected:  $DETECTED_ARCH"
        echo "Expected:  gfx1151 (Radeon 8060S)"
        echo "Reason:    The compiler target does not match the physical silicon."
        exit 1
    fi
else
    echo -e "\e[1;33m[WARNING: TOOL MISSING]\e[0m"
    echo "Tool: $AMDGPU_ARCH_BIN not found. Proceeding with caution..."
fi
# --- 1.7 Toolchain Executioner Verification ---
# Define the tools we require for Absolute Sovereignty
REQUIRED_TOOLS=("clang" "clang++" "ld.lld" "llvm-ar" "llvm-nm" "llvm-ranlib" "llvm-objcopy" "llvm-strip")
for tool in "${REQUIRED_TOOLS[@]}"; do
    if [ ! -f "$LLVM_PATH/bin/$tool" ]; then
        echo -e "\e[1;31m!!! [FATAL] Tool Missing: $LLVM_PATH/bin/$tool\e[0m"
        echo "Reason: Sequential Causality broken. The toolchain is incomplete."
        exit 1
    fi
done
# --- 2. Exporting the Vector of Truth ---
# Compilers
export CC=$LLVM_PATH/bin/clang
export CXX=$LLVM_PATH/bin/clang++
export CPP=$LLVM_PATH/bin/clang-cpp
# Linker (Enforce LLD to prevent GNU ld friction)
export LD=$LLVM_PATH/bin/ld.lld
# Binary Utilities
export AR=$LLVM_PATH/bin/llvm-ar
export NM=$LLVM_PATH/bin/llvm-nm
export RANLIB=$LLVM_PATH/bin/llvm-ranlib
export OBJCOPY=$LLVM_PATH/bin/llvm-objcopy
export STRIP=$LLVM_PATH/bin/llvm-strip
export READELF=$LLVM_PATH/bin/llvm-readelf
echo ">>> [TOOLCHAIN] All Executioners Armed. System is now Sovereign."

# --- 3. Auto-Activation of the Python Nation ---
if [ -d "$HOME/rocm_env" ]; then
    source "$HOME/rocm_env/bin/activate"
    # 1. Verify 8060S Hardware Substrate
    if [ -e /dev/kfd ] && [ -e /dev/dri/renderD128 ]; then
        GPU_STATUS="READY"
    else
        GPU_STATUS="DISCONNECTED"
    fi
    # 2. Locate the HIPIFY Translator
    HIPIFY_BIN=$(which hipify-perl 2>/dev/null)
    # 3. Output the Truth for the AI Observer
    echo ">>> [8060S] Sovereign Environment Active. Status: $GPU_STATUS"
    if [ ! -z "$HIPIFY_BIN" ]; then
        echo ">>> [HIPIFY] Translator Armed: $HIPIFY_BIN"
    else
        echo ">>> [HIPIFY] Translator Missing from PATH."
    fi
fi


##
# --- 1. ROCm & LLVM Path Sovereignty ---
# The Absolute Truth: /opt/rocm is the Root, /opt/rocm/llvm is the Executioner
export ROCM_PATH=/opt/rocm
export LLVM_PATH=/opt/rocm/llvm

# Hierarchy: Prioritize your custom standard-build tools
export PATH=$LLVM_PATH/bin:$ROCM_PATH/bin:$PATH

# REMOVE the GCC-14 path. Clang knows how to find its own runtimes.
export LD_LIBRARY_PATH=$LLVM_PATH/lib:$ROCM_PATH/lib:$LD_LIBRARY_PATH

# --- 2. AMD 8060S (gfx1151) Hardware Identity ---
# Direct mapping to the silicon truth
export HCC_AMDGPU_TARGET=gfx1151
export PYTORCH_ROCM_ARCH=gfx1151
export HIP_PLATFORM=amd
export HIP_RUNTIME=amd
export HIP_COMPILER=clang

# This is where ROCm-Device-Libs MUST be installed for Clang to see them
export DEVICE_LIB_PATH=/opt/rocm/amdgpu/lib

# --- 3. Sequential Causality Enforcement ---
# Use the Standardized Clang as the system-wide executioner
export CC=$LLVM_PATH/bin/clang
export CXX=$LLVM_PATH/bin/clang++


# --- 3. Auto-Activation of the Python Nation ---
if [ -d "$HOME/rocm_env" ]; then
    source "$HOME/rocm_env/bin/activate"
    
    # 1. Verify 8060S Hardware Substrate
    if [ -e /dev/kfd ] && [ -e /dev/dri/renderD128 ]; then
        GPU_STATUS="READY"
    else
        GPU_STATUS="DISCONNECTED"
    fi

    # 2. Locate the HIPIFY Translator
    HIPIFY_BIN=$(which hipify-perl 2>/dev/null)
    
    # 3. Output the Truth for the AI Observer
    echo ">>> [8060S] Sovereign Environment Active. Status: $GPU_STATUS"
    if [ ! -z "$HIPIFY_BIN" ]; then
        echo ">>> [HIPIFY] Translator Armed: $HIPIFY_BIN"
    else
        echo ">>> [HIPIFY] Translator Missing from PATH."
    fi
fi



















